<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –Ø–Ω–¥–µ–∫—Å OAuth - –ü—Ä—è–º–æ–π</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background: #f5f7fa; }
        .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; margin-bottom: 16px; }
        .btn { display: inline-block; padding: 12px 24px; background: #fc0; color: #000; text-decoration: none; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; font-size: 16px; margin: 5px; }
        .btn:hover { background: #f9a800; }
        .log { background: #1e1e1e; color: #fff; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 13px; max-height: 400px; overflow-y: auto; margin-top: 20px; }
        code { background: #f5f7fa; padding: 2px 6px; border-radius: 4px; font-size: 13px; }
        .status { padding: 12px; border-radius: 8px; margin: 16px 0; }
        .status.success { background: #e8f5e9; color: #2e7d32; }
        .status.error { background: #ffebee; color: #c62828; }
        .status.info { background: #e3f2fd; color: #1976d2; }
    </style>
</head>
<body>
    <div class="card">
        <h1>üß™ –¢–µ—Å—Ç –Ø–Ω–¥–µ–∫—Å OAuth - –ü—Ä—è–º–æ–π</h1>
        <p>–≠—Ç–æ—Ç —Ç–µ—Å—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ –æ–∫–Ω–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–Ω–µ popup).</p>
        
        <div id="status" class="status info">
            <strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="statusText">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
        </div>

        <div><strong>Client ID:</strong> <code id="clientId">...</code></div>
        <div><strong>Redirect URI:</strong> <code id="redirectUri">...</code></div>
        <div><strong>Scope:</strong> <code>disk:app_folder</code></div>
        <div><strong>Token:</strong> <code id="tokenStatus">–ù–µ –ø–æ–ª—É—á–µ–Ω</code></div>

        <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
        <button class="btn" onclick="startAuth()">üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–≤ —ç—Ç–æ–º –æ–∫–Ω–µ)</button>
        <button class="btn" onclick="clearToken()" style="background: #f44336; color: white;">üö™ –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
        <button class="btn" onclick="testAPI()" style="background: #4caf50; color: white;">üìä –¢–µ—Å—Ç API</button>
        <button class="btn" onclick="goToApp()" style="background: #2196f3; color: white;">üè† –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>

        <h2>–õ–æ–≥</h2>
        <div class="log" id="log"></div>
    </div>

    <script>
        const CONFIG = {
            CLIENT_ID: '3772de21483443aba93e1889bd7ca4dc',
            REDIRECT_URI: 'https://kkav45.github.io/cooperant/yandex-auth-callback.html',
            SCOPE: 'cloud_api:disk.app_folder'  // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π scope –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞
        };

        const STATE = Math.random().toString(36).substring(2);

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const item = document.createElement('div');
            item.style.color = type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#2196f3';
            item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(item);
            logEl.scrollTop = logEl.scrollHeight;
            console.log('[OAuth Test]', message);
        }

        function checkStatus() {
            const token = localStorage.getItem('yandexDiskToken');
            const tokenStatus = document.getElementById('tokenStatus');
            const statusText = document.getElementById('statusText');
            const statusDiv = document.getElementById('status');
            
            if (token) {
                tokenStatus.textContent = '‚úÖ –ü–æ–ª—É—á–µ–Ω (' + token.substring(0, 20) + '...)';
                tokenStatus.style.color = '#4caf50';
                statusDiv.className = 'status success';
                statusText.textContent = '–¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω!';
                log('‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω –≤ localStorage', 'success');
            } else {
                tokenStatus.textContent = '‚ùå –ù–µ –ø–æ–ª—É—á–µ–Ω';
                tokenStatus.style.color = '#f44336';
                statusDiv.className = 'status info';
                statusText.textContent = '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è';
                log('‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            const urlParams = new URLSearchParams(window.location.search);
            const hash = window.location.hash;
            
            if (urlParams.get('access_token')) {
                log('‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω –≤ URL parameters', 'success');
                handleToken(urlParams.get('access_token'));
            } else if (hash && hash.includes('access_token')) {
                log('‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω –≤ hash', 'success');
                const hashParams = new URLSearchParams(hash.substring(1));
                handleToken(hashParams.get('access_token'));
            }
        }

        function handleToken(token) {
            localStorage.setItem('yandexDiskToken', token);
            log('‚úÖ –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ localStorage', 'success');
            checkStatus();
            
            // –û—á–∏—â–∞–µ–º URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
            alert('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!\n\n–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω.\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–æ–º –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.');
        }

        function startAuth() {
            log('üöÄ –ù–∞—á–∞–ª–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...', 'info');
            
            const authUrl = `https://oauth.yandex.ru/authorize?` +
                `response_type=token&` +
                `client_id=${CONFIG.CLIENT_ID}&` +
                `redirect_uri=${encodeURIComponent(CONFIG.REDIRECT_URI)}&` +
                `scope=${encodeURIComponent(CONFIG.SCOPE)}&` +
                `state=${STATE}`;

            log(`üìç URL: ${authUrl.substring(0, 150)}...`, 'info');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫—É–¥–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è
            sessionStorage.setItem('oauth_return_to', window.location.href);
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ —Ç–æ–º –∂–µ –æ–∫–Ω–µ
            log('üîÑ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...', 'info');
            window.location.href = authUrl;
        }

        function clearToken() {
            localStorage.removeItem('yandexDiskToken');
            localStorage.removeItem('yandexCooperativFolderId');
            log('üóëÔ∏è –¢–æ–∫–µ–Ω –æ—á–∏—â–µ–Ω', 'success');
            checkStatus();
        }

        async function testAPI() {
            const token = localStorage.getItem('yandexDiskToken');
            
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω', 'error');
                alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è" –∏ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω!');
                return;
            }

            log('üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API...', 'info');

            try {
                const response = await fetch('https://cloud-api.yandex.net/v1/disk/resources?path=app-folder:/', {
                    headers: {
                        'Authorization': `OAuth ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'success');
                    log(`üìÅ –ü–∞–ø–∫–∞: ${data.name}`, 'success');
                    alert(`‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç!\n\n–ü–∞–ø–∫–∞: ${data.name}\n–ü—É—Ç—å: ${data.path}`);
                } else {
                    const error = await response.json();
                    log(`‚ùå –û—à–∏–±–∫–∞ API: ${error.message || response.status}`, 'error');
                    alert(`‚ùå –û—à–∏–±–∫–∞ API: ${error.message || response.status}`);
                }
            } catch (err) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${err.message}`, 'error');
                alert(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`);
            }
        }

        function goToApp() {
            log('üè† –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...', 'info');
            const token = localStorage.getItem('yandexDiskToken');
            if (!token) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å!');
                return;
            }
            window.location.href = 'start.html';
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        document.getElementById('clientId').textContent = CONFIG.CLIENT_ID;
        document.getElementById('redirectUri').textContent = CONFIG.REDIRECT_URI;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        checkStatus();
    </script>
</body>
</html>
