<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0088cc">
    <title>Кооператив Мессенджер</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏠</text></svg>">

    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Google Fonts: Roboto (кириллица) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap&subset=cyrillic" rel="stylesheet">

    <style>
        /* TELEGRAM THEME VARIABLES */
        :root {
            --tg-bg-color: var(--tg-theme-bg-color, #ffffff);
            --tg-text-color: var(--tg-theme-text-color, #000000);
            --tg-hint-color: var(--tg-theme-hint-color, #999999);
            --tg-button-color: var(--tg-theme-button-color, #2481cc);
            --tg-button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg-color: var(--tg-theme-secondary-bg-color, #f0f2f5);

            /* Приложение */
            --bg-primary: var(--tg-secondary-bg-color, #f0f2f5);
            --bg-secondary: var(--tg-bg-color, #ffffff);
            --text-primary: var(--tg-text-color, #000000);
            --text-secondary: var(--tg-hint-color, #999999);
            --border-color: rgba(128, 128, 128, 0.2);
            --hover-bg: var(--tg-secondary-bg-color, #f5f7fa);
        }

        /* Принудительное применение цветов Telegram */
        * {
            box-sizing: border-box;
        }

        html, body {
            background-color: var(--tg-secondary-bg-color);
            color: var(--tg-text-color);
        }

        /* Все фоновые элементы */
        .sidebar-menu,
        .chats-panel,
        .menu-content,
        .chats-list,
        .chat-item,
        .message-input-area,
        .search-box,
        .filter-chip,
        .menu-item,
        .report-card,
        .detail-value,
        .action-btn.secondary,
        .fab-item-label {
            background: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
        }

        /* Основные области */
        .main-chat,
        .messages-container,
        .large-report-panel,
        .side-menu-overlay {
            background: var(--bg-primary) !important;
        }

        /* Текст во всех элементах */
        .chat-name,
        .chat-time,
        .last-message,
        .cooperative-name,
        .cooperative-stats,
        .menu-item-name,
        .menu-item-subtitle,
        .menu-section-title,
        .report-card-title,
        .report-card-desc,
        .message-content,
        .message-time,
        .detail-label {
            color: var(--text-primary) !important;
        }

        /* Границы */
        .sidebar-menu,
        .chats-panel,
        .chat-item,
        .menu-item,
        .search-box,
        .message-input,
        .detail-value {
            border-color: var(--border-color) !important;
        }

        /* Вторичный текст */
        .chat-time,
        .last-message,
        .cooperative-stats,
        .menu-item-subtitle,
        .report-card-desc,
        .message-time,
        .detail-label,
        .filter-chip {
            color: var(--text-secondary) !important;
        }

        /* Адаптация для тёмной темы - убираем жёсткие цвета */
        @media (prefers-color-scheme: dark) {
            /* Светлые фоны делаем тёмными */
            [style*="background:#fff"],
            [style*="background:#ffffff"],
            [style*="background:#f5f7fa"],
            [style*="background:#e3f2fd"],
            [style*="background:#e8f5e9"],
            [style*="background:#fff3e0"],
            [style*="background:#ffebee"] {
                background: var(--bg-secondary) !important;
            }
            
            /* Тёмный текст делаем светлым */
            [style*="color:#000"],
            [style*="color:#000000"],
            [style*="color:#333"],
            [style*="color:#666"] {
                color: var(--text-primary) !important;
            }
        }
        
        .container {
            display: flex;
            height: 100%;
            height: 100dvh;  /* Dynamic viewport height для мобильных */
            position: relative;
            overflow: hidden;
        }
        
        /* БАЗОВЫЕ СТИЛИ - ШРИФТЫ */
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            font-size: 15px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Заголовки */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            font-weight: 500;
            line-height: 1.3;
        }
        
        /* Кнопки и элементы форм */
        button, input, select, textarea {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
        }
        
        /* БАЗОВЫЕ СТИЛИ ДЛЯ ДЕСКТОПА */
        .chats-panel {
            position: relative;
            width: 100%;
            max-width: 400px;  /* Единая ширина для чатов и меню */
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 50;
        }
        
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            min-width: 0;
            position: relative;
        }
        
        /* ЛЕВОЕ МЕНЮ НАВИГАЦИИ - единая ширина с чатами */
        .sidebar-menu {
            width: 100%;
            max-width: 400px;  /* = chats-panel */
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            height: 100%;
            height: 100dvh;
            z-index: 200;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
        }
        
        .sidebar-menu.visible {
            transform: translateX(0);
        }

        /* КНОПКА ЯНДЕКС.ДИСКА */
        .yandex-disk-section {
            padding: 10px 16px;
            background: linear-gradient(135deg, #fc0 0%, #f9a800 100%);
            border-bottom: 1px solid var(--border-color);
        }

        .yandex-disk-status {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            gap: 10px;
        }

        .yandex-disk-status:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(252, 0, 0, 0.15);
        }

        .yandex-disk-status:active {
            transform: translateY(0);
        }

        .yandex-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .yandex-text {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
            color: #000;
        }

        .yandex-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            flex-shrink: 0;
        }

        .yandex-indicator.disconnected {
            background: #f44336;
        }

        .yandex-indicator.syncing {
            background: #ff9800;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .menu-header {
            padding: 20px 16px;
            padding-top: max(20px, env(safe-area-inset-top));
            background: linear-gradient(135deg, #0088cc, #0066aa);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .menu-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* СТИЛИЗАЦИЯ СКРОЛЛБАРОВ - единообразные */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        
        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }
        .menu-section { padding: 15px 0; border-bottom: 1px solid #f0f0f0; }
        .menu-section-title {
            padding: 0 20px 10px;
            font-size: 11px;
            font-weight: bold;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .menu-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .menu-item:hover { background: var(--hover-bg); }
        .menu-item-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .menu-item-info { flex: 1; min-width: 0; }
        .menu-item-name { font-weight: 500; font-size: 13px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .menu-item-subtitle { font-size: 11px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .menu-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            background: #e0e0e0;
            margin-left: 8px;
            flex-shrink: 0;
        }
        .menu-badge.alert { background: #ffebee; color: #c62828; }
        .menu-badge.success { background: #e8f5e9; color: #2e7d32; }
        .menu-arrow { color: #ccc; margin-left: 8px; font-size: 14px; }
        
        /* OVERLAY для закрытия панелей */
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }
        
        .panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* ПОДМЕНЮ ОТЧЕТОВ */
        .table-filters {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #f5f7fa;
            border-bottom: 1px solid #e0e0e0;
            flex-wrap: wrap;
        }
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
        }
        .filter-input:focus {
            border-color: #0088cc;
            box-shadow: 0 0 0 2px rgba(0,136,204,0.1);
        }
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
            cursor: pointer;
        }

        /* TOAST УВЕДОМЛЕНИЯ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .toast {
            min-width: 300px;
            padding: 16px 20px;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            pointer-events: auto;
        }
        .toast.success { background: #e8f5e9; border-left: 4px solid #4caf50; }
        .toast.error { background: #ffebee; border-left: 4px solid #f44336; }
        .toast.warning { background: #fff3e0; border-left: 4px solid #ff9800; }
        .toast.info { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .toast-icon { font-size: 20px; }
        .toast-message { flex: 1; font-size: 14px; color: #333; }
        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
        }
        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
        
        /* INDOCTOR ЗАГРУЗКИ */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loader-overlay.active {
            display: flex;
        }
        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid #fff;
            border-top-color: #0088cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ПОДМЕНЮ ОТЧЕТОВ */
        .reports-submenu {
            width: 400px;
            min-width: 400px;
            background: #fff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        .reports-submenu.visible { transform: translateX(0); }
        
        .submenu-header {
            padding: 20px 15px;
            background: linear-gradient(135deg, #0088cc, #0066aa);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .submenu-title { font-size: 16px; font-weight: 600; }
        .submenu-back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .submenu-content { flex: 1; overflow-y: auto; padding: 15px; }
        .submenu-section { margin-bottom: 20px; }
        .submenu-section-title {
            font-size: 11px;
            font-weight: bold;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 12px;
            padding-left: 10px;
            letter-spacing: 0.5px;
        }
        .report-card {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f5f7fa;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .report-card:hover { background: #e3f2fd; transform: translateX(4px); }
        .report-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .report-card-info { flex: 1; min-width: 0; }
        .report-card-title { font-weight: 600; font-size: 13px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .report-card-desc { font-size: 11px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* СПИСОК ЧАТОВ - ВСЕГДА НА МЕСТЕ */
        .chats-panel {
            width: 400px;
            min-width: 400px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            z-index: 50;
            position: relative;
        }
        
        .chats-header {
            padding: 15px;
            background: #fff;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        .burger-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #f5f7fa;
            cursor: pointer;
            font-size: 20px;
        }
        .burger-btn:hover { background: #e0e0e0; }
        
        .cooperative-info { flex: 1; }
        .cooperative-name { font-weight: 600; font-size: 14px; }
        .cooperative-stats { font-size: 12px; color: #666; }
        
        .search-section {
            padding: 12px 15px;
            background: #f5f7fa;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        .search-box {
            display: flex;
            align-items: center;
            background: #fff;
            border-radius: 20px;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
        }
        .search-box input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 14px;
        }
        .quick-filters {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .filter-chip {
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            background: #fff;
            font-size: 12px;
            cursor: pointer;
        }
        .filter-chip.active { background: #0088cc; color: #fff; border-color: #0088cc; }
        
        .chats-list { flex: 1; overflow-y: auto; }
        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f2f5;
            cursor: pointer;
        }
        .chat-item:hover { background: #f5f7fa; }
        .chat-item.active { background: #e3f2fd; }
        .chat-item .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            margin-right: 12px;
            font-size: 18px;
            flex-shrink: 0;
        }
        .chat-item .chat-info {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .chat-item .chat-top, .chat-item .chat-middle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }
        .chat-item .chat-name {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-item .chat-time { font-size: 11px; color: #999; }
        .chat-item .status { font-size: 11px; }
        .chat-item .status::before { content: '●'; margin-right: 4px; }
        .chat-item .status.active { color: #4caf50; }
        .chat-item .status.debt { color: #f44336; }
        .chat-item .status.pending { color: #ff9800; }
        .chat-item .balance { font-size: 12px; font-weight: 600; }
        .chat-item .balance.positive { color: #4caf50; }
        .chat-item .balance.negative { color: #f44336; }
        .chat-item .last-message {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* МАССОВЫЕ ОПЕРАЦИИ */
        .chat-item.selectable {
            position: relative;
            padding-left: 50px;
        }
        .chat-checkbox {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .mass-actions-panel {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: #fff;
            padding: 15px 25px;
            border-radius: 50px;
            display: none;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        .mass-actions-panel.active {
            display: flex;
            transform: translateX(-50%) translateY(0);
        }
        .mass-actions-panel button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
        }
        .mass-actions-panel button:hover {
            background: rgba(255,255,255,0.3);
        }
        .mass-count {
            font-weight: 600;
            font-size: 14px;
        }
        
        /* ЦЕНТРАЛЬНАЯ ЧАСТЬ */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f0f2f5;
            min-height: 0;
            position: relative;
        }
        .chat-header {
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .chat-header-left { display: flex; align-items: center; flex: 1; }
        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0088cc, #0066aa);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            margin-right: 12px;
        }
        .chat-header-name { font-weight: 600; font-size: 16px; }
        .chat-header-status { font-size: 12px; color: #4caf50; margin-top: 2px; }
        .chat-header-actions { display: flex; gap: 8px; }
        .header-action-btn, .menu-more-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #f5f7fa;
            cursor: pointer;
            font-size: 16px;
        }
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .message {
            max-width: 600px;
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            cursor: pointer;
            background: #fff;
            align-self: flex-start;
            border-top-left-radius: 4px;
        }
        .message.sent {
            background: #d9fdd3;
            align-self: flex-end;
            border-top-right-radius: 4px;
        }
        .message-type { font-size: 11px; color: #0088cc; font-weight: 600; margin-bottom: 4px; text-transform: uppercase; }
        .message-content { font-size: 14px; color: #333; margin-bottom: 6px; }
        .message-amount { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
        .message-time { font-size: 11px; color: #666; text-align: right; }
        .message-input-wrapper {
            background: #fff;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        .message-input-area {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .attach-btn, .voice-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #f5f7fa;
            cursor: pointer;
            font-size: 18px;
        }
        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 24px;
            outline: none;
            font-size: 14px;
        }
        .send-button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #0088cc, #0066aa);
            color: #fff;
            cursor: pointer;
            font-size: 18px;
        }
        
        /* БОЛЬШАЯ ПРАВАЯ ПАНЕЛЬ (отчеты) */
        .large-report-panel {
            position: absolute;
            left: 400px;
            right: 0;
            top: 0;
            height: 100%;
            background: #f5f7fa;
            z-index: 97;
            display: none;
            flex-direction: column;
        }
        .large-report-panel.visible { display: flex; }
        .large-report-header {
            padding: 20px 30px;
            background: linear-gradient(135deg, #0088cc, #0066aa);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .large-report-title { font-size: 18px; font-weight: 600; }
        .close-large-report-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
        }
        .large-report-content { flex: 1; overflow-y: auto; padding: 30px; }
        
        /* ПРАВАЯ ПАНЕЛЬ (инфо о пайщике, детали) - большие */
        .sidebar-right, .operation-details-panel, .menu-content-panel {
            width: 100%;
            max-width: 400px;  /* Большие панели */
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            height: 100dvh;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
        }
        .sidebar-right.visible, .operation-details-panel.visible, .menu-content-panel.visible {
            transform: translateX(0);
        }
        .member-info-header, .details-header, .menu-panel-header {
            padding: 20px;
            background: linear-gradient(135deg, #0088cc, #0066aa);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .close-info-btn, .close-details-btn, .close-panel-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }
        .member-info-content, .details-content, .menu-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* Детали операции */
        .detail-tabs { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; }
        .detail-tab {
            padding: 10px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .detail-tab.active { color: #0088cc; border-bottom-color: #0088cc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .detail-item { margin-bottom: 16px; }
        .detail-label { font-size: 12px; color: #666; margin-bottom: 6px; font-weight: 500; }
        .detail-value { padding: 10px 12px; background: #f5f7fa; border-radius: 8px; font-size: 14px; }
        .detail-value.highlight { background: #e3f2fd; color: #0088cc; font-weight: 600; }
        .action-buttons { display: flex; flex-direction: column; gap: 8px; margin-top: 24px; }
        .action-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .action-btn.primary { background: linear-gradient(135deg, #0088cc, #0066aa); color: #fff; }
        .action-btn.secondary { background: #f5f7fa; color: #333; }
        .action-btn.danger { background: #ffebee; color: #c62828; }
        
        /* Инфо о пайщике */
        .member-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 32px;
            margin: 0 auto 15px;
        }
        .member-name-large { text-align: center; font-size: 18px; font-weight: 600; margin-bottom: 5px; }
        .member-status-large { text-align: center; font-size: 13px; color: #666; margin-bottom: 20px; }
        .balance-card {
            background: linear-gradient(135deg, #0088cc, #0066aa);
            color: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .balance-label { font-size: 13px; opacity: 0.9; margin-bottom: 8px; }
        .balance-amount { font-size: 28px; font-weight: 700; }
        .info-section { margin-bottom: 25px; }
        .info-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f5f7fa;
        }
        .info-label { font-size: 13px; color: #666; }
        .info-value { font-size: 13px; font-weight: 500; color: #333; }
        .info-actions { display: flex; flex-direction: column; gap: 8px; margin-top: 20px; }
        .info-action-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .info-action-btn.primary { background: linear-gradient(135deg, #0088cc, #0066aa); color: #fff; }
        .info-action-btn.secondary { background: #f5f7fa; color: #333; }
        .info-action-btn.danger { background: #ffebee; color: #c62828; }
        
        /* FAB КНОПКА */
        .fab-container {
            position: fixed;
            right: 20px;
            bottom: 90px;
            z-index: 1000;
            transition: opacity 0.3s, transform 0.3s;
        }
        .fab-container.hidden {
            opacity: 0;
            transform: scale(0);
            pointer-events: none;
        }
        .fab-main {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0088cc, #0066aa);
            color: #fff;
            border: none;
            box-shadow: 0 4px 12px rgba(0,136,204,0.4);
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fab-main:hover { transform: scale(1.1); }
        .fab-main.close { transform: rotate(45deg); }
        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: flex;
            flex-direction: column-reverse;
            gap: 12px;
            pointer-events: none;
        }
        .fab-menu.expanded { pointer-events: all; }
        .fab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            transition: all 0.3s;
            cursor: pointer;
        }
        .fab-menu.expanded .fab-item {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        .fab-item-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            color: #fff;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fab-item-label {
            margin-top: 4px;
            font-size: 11px;
            color: #333;
            background: rgba(255,255,255,0.95);
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }
        
        /* Адаптивность */
        
        /* ДЕСКТОП (>1024px) - единая ширина 400px */
        @media (min-width: 1025px) {
            .sidebar-menu {
                width: 100%;
                max-width: 400px;  /* = chats-panel */
            }
            
            .chats-panel {
                width: 100%;
                max-width: 400px;
            }
            
            .sidebar-right,
            .operation-details-panel,
            .menu-content-panel {
                width: 100%;
                max-width: 400px;  /* Большие панели */
            }
            
            .large-report-panel {
                left: 400px;
                right: 0;
                width: auto;
                max-width: none;
            }
        }
        
        /* ПЛАНШЕТ (768px - 1024px) */
        @media (max-width: 1024px) {
            .sidebar-menu, .reports-submenu, .chats-panel { width: 100%; max-width: 400px; }
            .sidebar-right, .operation-details-panel, .menu-content-panel, .large-report-panel { width: 100%; max-width: 400px; }
            .message { max-width: 600px; }
        }
        
        /* МОБИЛЬНЫЙ (481px - 768px) */
        @media (max-width: 768px) {
            .sidebar-menu, .reports-submenu, .chats-panel { width: 100%; max-width: 80%; }
            .sidebar-right, .operation-details-panel, .menu-content-panel, .large-report-panel { width: 100%; max-width: 100%; }
            .message { max-width: 600px; }
        }
        
        /* МАЛЕНЬКИЙ МОБИЛЬНЫЙ (<=480px) */
        @media (max-width: 480px) {
            .sidebar-menu, .reports-submenu, .chats-panel { width: 100%; max-width: 100%; }
        }
        
        /* Safe Areas (iPhone X и новее) */
        @supports (padding: max(0px)) {
            .chat-header, .chats-header, .message-input-area {
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }
            
            .menu-header {
                padding-top: max(20px, env(safe-area-inset-top));
            }
        }
    </style>
</head>
<body>
    <!-- OVERLAY для закрытия панелей -->
    <div class="panel-overlay" id="panelOverlay"></div>
    
    <div class="container">
        <!-- ЛЕВОЕ МЕНЮ НАВИГАЦИИ -->
        <div class="sidebar-menu" id="sidebarMenu">
            <div class="menu-header">
                <div class="menu-title">🏠 Кооператив</div>
                <button class="menu-close-btn" id="menuCloseBtn">◀</button>
            </div>

            <!-- КНОПКА ЯНДЕКС.ДИСКА -->
            <div class="yandex-disk-section" id="yandexDiskSection">
                <div class="yandex-disk-status" id="yandexDiskStatus" onclick="handleYandexDiskClick()">
                    <span class="yandex-icon">☁️</span>
                    <span class="yandex-text" id="yandexDiskText">Яндекс Диск</span>
                    <span class="yandex-indicator" id="yandexIndicator"></span>
                </div>
            </div>

            <!-- ПОИСК ПО МЕНЮ -->
            <div style="padding:12px 16px;background:#f5f7fa;border-bottom:1px solid var(--border-color)">
                <input type="text" id="menuSearch" placeholder="🔍 Поиск..." 
                       style="width:100%;padding:8px 12px;border:1px solid var(--border-color);border-radius:6px;font-size:14px;outline:none;background:var(--bg-secondary);color:var(--text-primary)">
            </div>
            
            <div class="menu-content">
                <!-- ⚡ БЫСТРЫЙ ДОСТУП -->
                <div class="menu-section">
                    <div class="menu-section-title">⚡ Быстрый доступ</div>
                    <div class="menu-item" data-panel="favorites">
                        <div class="menu-item-icon" style="background:#fff3e0">⭐</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Избранное</div>
                            <div class="menu-item-subtitle">Частые операции</div>
                        </div>
                    </div>
                    <div class="menu-item" data-report="calendar-full">
                        <div class="menu-item-icon" style="background:#e3f2fd">📅</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Календарь событий</div>
                            <div class="menu-item-subtitle">Планы и сроки</div>
                        </div>
                    </div>
                </div>

                <!-- 👥 ПАЙЩИКИ -->
                <div class="menu-section">
                    <div class="menu-section-title">👥 Пайщики</div>
                    <div class="menu-item" data-report="members-registry-full">
                        <div class="menu-item-icon" style="background:#e8f5e9">📋</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Реестр пайщиков</div>
                            <div class="menu-item-subtitle">Список пайщиков</div>
                        </div>
                        <span class="menu-badge success">12</span>
                    </div>
                    <div class="menu-item" data-action="create-member">
                        <div class="menu-item-icon" style="background:#e8f5e9">➕</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Добавить пайщика</div>
                            <div class="menu-item-subtitle">Новый пайщик</div>
                        </div>
                    </div>
                    <div class="menu-item" data-action="edit-member">
                        <div class="menu-item-icon" style="background:#e8f5e9">✏️</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Редактировать пайщика</div>
                            <div class="menu-item-subtitle">Исправить данные</div>
                        </div>
                    </div>
                    <div class="menu-item" data-report="certificates-registry-full">
                        <div class="menu-item-icon" style="background:#fce4ec">📜</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Удостоверения</div>
                            <div class="menu-item-subtitle">Выданные бланки</div>
                        </div>
                    </div>
                </div>

                <!-- 💳 ВЗНОСЫ -->
                <div class="menu-section">
                    <div class="menu-section-title">💳 Взносы</div>
                    <div class="menu-item" data-report="payments-report-full">
                        <div class="menu-item-icon" style="background:#e3f2fd">📊</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Отчёт по взносам</div>
                            <div class="menu-item-subtitle">Поступления</div>
                        </div>
                    </div>
                    <div class="menu-item" data-action="create-payment">
                        <div class="menu-item-icon" style="background:#e3f2fd">➕</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Добавить взнос</div>
                            <div class="menu-item-subtitle">Новый взнос</div>
                        </div>
                    </div>
                    <div class="menu-item" data-action="create-return-payment">
                        <div class="menu-item-icon" style="background:#ffebee">↩️</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Возврат взноса</div>
                            <div class="menu-item-subtitle">Оформить возврат</div>
                        </div>
                    </div>
                </div>

                <!-- 📘 БУХГАЛТЕРИЯ -->
                <div class="menu-section">
                    <div class="menu-section-title">📘 Бухгалтерия</div>
                    <div class="menu-item" data-action="create-transaction">
                        <div class="menu-item-icon" style="background:#fff3e0">📒</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Добавить проводку</div>
                            <div class="menu-item-subtitle">Бухгалтерская проводка</div>
                        </div>
                    </div>
                    <div class="menu-item" data-report="osv">
                        <div class="menu-item-icon" style="background:#fff3e0">📊</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">ОСВ</div>
                            <div class="menu-item-subtitle">Оборотно-сальдовая</div>
                        </div>
                    </div>
                    <div class="menu-item" data-action="pko">
                        <div class="menu-item-icon" style="background:#e3f2fd">📝</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">ПКО</div>
                            <div class="menu-item-subtitle">Приходный ордер</div>
                        </div>
                    </div>
                    <div class="menu-item" data-action="rko">
                        <div class="menu-item-icon" style="background:#e3f2fd">📝</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">РКО</div>
                            <div class="menu-item-subtitle">Расходный ордер</div>
                        </div>
                    </div>
                    <div class="menu-item" data-action="payment-order">
                        <div class="menu-item-icon" style="background:#e8f5e9">💰</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Платёжное поручение</div>
                            <div class="menu-item-subtitle">Банковский платёж</div>
                        </div>
                    </div>
                    <div class="menu-item" data-submenu="accounting-reports">
                        <div class="menu-item-icon" style="background:#fff3e0">📊</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Отчёты</div>
                            <div class="menu-item-subtitle">Балансы, справки</div>
                        </div>
                        <span class="menu-arrow">→</span>
                    </div>
                    <!-- Раскрытые отчёты -->
                    <div class="reports-expanded" data-parent="accounting-reports" style="padding-left:58px;padding-top:5px;display:none">
                        <div class="menu-item" data-report="balance" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">⚖️</span>Бухгалтерский баланс</div>
                        <div class="menu-item" data-report="profit-loss" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">📈</span>Отчёт о фин. результатах</div>
                        <div class="menu-item" data-report="target-use" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">🎯</span>Отчёт о целевом использовании</div>
                        <div class="menu-item" data-report="accounting-certificate" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">📄</span>Бухгалтерская справка</div>
                    </div>
                </div>

                <!-- 📙 НАЛОГИ -->
                <div class="menu-section">
                    <div class="menu-section-title">📙 Налоги</div>
                    <div class="menu-item" data-report="kudir">
                        <div class="menu-item-icon" style="background:#fff3e0">📖</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">КУДиР</div>
                            <div class="menu-item-subtitle">Книга учёта</div>
                        </div>
                    </div>
                    <div class="menu-item" data-report="usn-declaration">
                        <div class="menu-item-icon" style="background:#fff3e0">📋</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Декларация УСН</div>
                            <div class="menu-item-subtitle">Налоговая отчётность</div>
                        </div>
                    </div>
                    <div class="menu-item" data-action="act-sverka">
                        <div class="menu-item-icon" style="background:#f5f5f5">📊</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Акт сверки</div>
                            <div class="menu-item-subtitle">Сверка с контрагентами</div>
                        </div>
                    </div>
                    <div class="menu-item" data-submenu="zero-reporting">
                        <div class="menu-item-icon" style="background:#f5f5f5">∅</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Нулевая отчётность</div>
                            <div class="menu-item-subtitle">При отсутствии деятельности</div>
                        </div>
                        <span class="menu-arrow">→</span>
                    </div>
                    <!-- Раскрытые отчёты -->
                    <div class="reports-expanded" data-parent="zero-reporting" style="padding-left:58px;padding-top:5px;display:none">
                        <div class="menu-item" data-action="generate-usn-zero" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">📋</span>Декларация УСН</div>
                        <div class="menu-item" data-action="generate-balance-zero" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">⚖️</span>Баланс</div>
                        <div class="menu-item" data-action="generate-szv-zero" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">📊</span>СЗВ-СТАЖ</div>
                        <div class="menu-item" data-action="generate-rsv-zero" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">📊</span>РСВ</div>
                        <div class="menu-item" data-action="generate-sredn-zero" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">👥</span>Среднесписочная</div>
                    </div>
                </div>

                <!-- 📗 УПРАВЛЕНЧЕСКИЙ УЧЁТ -->
                <div class="menu-section">
                    <div class="menu-section-title">📗 Управленческий учёт</div>
                    <div class="menu-item" data-submenu="analytics">
                        <div class="menu-item-icon" style="background:#e8f5e9">📈</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Аналитика</div>
                            <div class="menu-item-subtitle">Отчёты, графики</div>
                        </div>
                        <span class="menu-arrow">→</span>
                    </div>
                    <!-- Раскрытые отчёты -->
                    <div class="reports-expanded" data-parent="analytics" style="padding-left:58px;padding-top:5px;display:none">
                        <div class="menu-item" data-report="members-report-full" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">📋</span>Реестр пайщиков</div>
                        <div class="menu-item" data-report="payments-report-full" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">💳</span>Отчёт по взносам</div>
                        <div class="menu-item" data-report="financial-report-full" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">📈</span>Финансовый отчёт</div>
                        <div class="menu-item" data-report="debt-report" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">⚠️</span>Отчёт о задолженностях</div>
                    </div>
                    <div class="menu-item" data-submenu="funds">
                        <div class="menu-item-icon" style="background:#e8f5e9">💰</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Фонды</div>
                            <div class="menu-item-subtitle">Отчёты по фондам</div>
                        </div>
                        <span class="menu-arrow">→</span>
                    </div>
                    <!-- Раскрытые отчёты по фондам -->
                    <div class="reports-expanded" data-parent="funds" style="padding-left:58px;padding-top:5px;display:none">
                        <div class="menu-item" data-report="share-fund" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">💰</span>Паевой фонд</div>
                        <div class="menu-item" data-report="development-fund" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">🚀</span>Фонд развития</div>
                        <div class="menu-item" data-report="business-fund" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">🏢</span>Фонд хоз. деятельности</div>
                        <div class="menu-item" data-report="funds-analytics" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">📊</span>Аналитика фондов</div>
                        <div class="menu-item" data-report="indivisible-fund" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">🏛️</span>Неделимый фонд</div>
                        <div class="menu-item" data-report="reserve-fund" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">🛡️</span>Резервный фонд</div>
                    </div>
                    <div class="menu-item" data-submenu="meetings">
                        <div class="menu-item-icon" style="background:#e8f5e9">📝</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Собрания</div>
                            <div class="menu-item-subtitle">Протоколы, регистрация</div>
                        </div>
                        <span class="menu-arrow">→</span>
                    </div>
                    <!-- Раскрытые отчёты -->
                    <div class="reports-expanded" data-parent="meetings" style="padding-left:58px;padding-top:5px;display:none">
                        <div class="menu-item" data-action="create-meeting" style="padding:8px 12px;font-size:12px;cursor:pointer;background:#e8f5e9;border-radius:4px;margin-bottom:8px"><span style="margin-right:8px">➕</span>Создать протокол</div>
                        <div class="menu-item" data-report="meeting-protocol-full" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">📝</span>Протокол собрания</div>
                        <div class="menu-item" data-report="attendance-list-full" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">✍️</span>Лист регистрации</div>
                    </div>
                    <div class="menu-item" data-submenu="control">
                        <div class="menu-item-icon" style="background:#e8f5e9">⏰</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Контроль</div>
                            <div class="menu-item-subtitle">Сроки, напоминания</div>
                        </div>
                        <span class="menu-arrow">→</span>
                    </div>
                    <!-- Раскрытые отчёты -->
                    <div class="reports-expanded" data-parent="control" style="padding-left:58px;padding-top:5px;display:none">
                        <div class="menu-item" data-action="add-calendar-event" style="padding:8px 12px;font-size:12px;cursor:pointer;background:#e8f5e9;border-radius:4px;margin-bottom:8px"><span style="margin-right:8px">➕</span>Добавить мероприятие</div>
                        <div class="menu-item" data-report="calendar-full" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">📅</span>Календарь событий</div>
                        <div class="menu-item" data-report="control-dashboard" style="padding:8px 12px;font-size:12px;cursor:pointer"><span style="margin-right:8px">⏰</span>Контроль сроков</div>
                    </div>
                </div>

                <!-- 📁 ДОКУМЕНТЫ -->
                <div class="menu-section">
                    <div class="menu-section-title">📁 Документы</div>
                    <div class="menu-item" data-action="create-document">
                        <div class="menu-item-icon" style="background:#f5f7fa">📁</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Загрузить документ</div>
                            <div class="menu-item-subtitle">Новый документ</div>
                        </div>
                    </div>
                    <div class="menu-item" data-action="invoice">
                        <div class="menu-item-icon" style="background:#f5f7fa">📄</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Счёт на оплату</div>
                            <div class="menu-item-subtitle">Выставить счёт</div>
                        </div>
                    </div>
                </div>

                <!-- 📋 ЗАЯВЛЕНИЯ -->
                <div class="menu-section">
                    <div class="menu-section-title">📋 Заявления</div>
                    <div class="menu-item" data-action="create-application">
                        <div class="menu-item-icon" style="background:#fce4ec">📝</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Подать заявление</div>
                            <div class="menu-item-subtitle">На вступление</div>
                        </div>
                    </div>
                    <div class="menu-item" data-report="applications-registry">
                        <div class="menu-item-icon" style="background:#fce4ec">📋</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Реестр заявлений</div>
                            <div class="menu-item-subtitle">Все заявления</div>
                        </div>
                    </div>
                </div>

                <!-- ⚙️ НАСТРОЙКИ -->
                <div class="menu-section">
                    <div class="menu-section-title">⚙️ Настройки</div>
                    <div class="menu-item" data-panel="profile">
                        <div class="menu-item-icon" style="background:#e0e0e0">👤</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Профиль</div>
                            <div class="menu-item-subtitle">Пользователь</div>
                        </div>
                    </div>
                    <div class="menu-item" onclick="toggleDarkMode()">
                        <div class="menu-item-icon" style="background:#e0e0e0">🌓</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Тёмная тема</div>
                            <div class="menu-item-subtitle">Переключить тему</div>
                        </div>
                    </div>
                    <div class="menu-item" onclick="exportMembersToExcel()">
                        <div class="menu-item-icon" style="background:#e0e0e0">📊</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Экспорт в Excel</div>
                            <div class="menu-item-subtitle">Выгрузить данные</div>
                        </div>
                    </div>
                    <div class="menu-item" data-panel="backup">
                        <div class="menu-item-icon" style="background:#e0e0e0">💾</div>
                        <div class="menu-item-info">
                            <div class="menu-item-name">Резервное копирование</div>
                            <div class="menu-item-subtitle">Сохранение данных</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TOAST КОНТЕЙНЕР -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- INDOCTOR ЗАГРУЗКИ -->
        <div class="loader-overlay" id="loaderOverlay">
            <div class="loader"></div>
        </div>

        <!-- ПОДМЕНЮ ОТЧЕТОВ -->
        <div class="reports-submenu" id="reportsSubmenu">
            <div class="submenu-header">
                <button class="submenu-back-btn" id="submenuBackBtn">← Назад</button>
                <div class="submenu-title" id="submenuTitle">Отчеты</div>
                <div style="width:80px"></div>
            </div>
            <div class="submenu-content" id="submenuContent"></div>
        </div>
        
        <!-- СПИСОК ЧАТОВ - ВСЕГДА НА МЕСТЕ -->
        <div class="chats-panel" id="chatsPanel">
            <div class="chats-header">
                <button class="burger-btn" id="burgerBtn" data-tooltip="Меню (Ctrl+M)">☰</button>
                <div class="cooperative-info">
                    <div class="cooperative-name">Потребительский кооператив</div>
                    <div class="cooperative-stats">12 пайщиков • 9 активных</div>
                </div>
            </div>
            <div class="search-section">
                <div class="search-box">
                    <span>🔍</span>
                    <input type="text" placeholder="Поиск пайщиков..." id="searchInput">
                </div>
                <div class="quick-filters">
                    <button class="filter-chip active">Все</button>
                    <button class="filter-chip">🔴 Должники</button>
                    <button class="filter-chip">🟢 Активные</button>
                </div>
            </div>
            <div class="chats-list" id="chatsList"></div>
        </div>
        
        <!-- ЦЕНТРАЛЬНАЯ ЧАСТЬ -->
        <div class="main-chat">
            <div class="chat-header">
                <div class="chat-header-left">
                    <button class="header-action-btn" id="massSelectBtn" title="Массовые операции" style="margin-right:10px">☑️</button>
                    <div class="chat-header-avatar" id="currentAvatar">ИИ</div>
                    <div>
                        <div class="chat-header-name" id="currentName">Иванов Иван Иванович</div>
                        <div class="chat-header-status">● Активен</div>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button class="header-action-btn" title="Позвонить">📞</button>
                    <button class="header-action-btn" title="Email">✉️</button>
                    <button class="menu-more-btn" id="menuMoreBtn" title="Информация" data-tooltip="Информация о пайщике">⋮</button>
                </div>
            </div>
            <div class="messages-container" id="messagesContainer"></div>
            <div class="message-input-wrapper">
                <div class="message-input-area">
                    <button class="attach-btn">📎</button>
                    <input type="text" class="message-input" placeholder="Добавить операцию..." id="messageInput">
                    <button class="voice-btn">🎤</button>
                    <button class="send-button" id="sendButton">➤</button>
                </div>
            </div>
        </div>
        
        <!-- БОЛЬШАЯ ПРАВАЯ ПАНЕЛЬ (отчеты) -->
        <div class="large-report-panel" id="largeReportPanel">
            <div class="large-report-header">
                <div class="large-report-title" id="largeReportTitle">Отчет</div>
                <button class="close-large-report-btn" id="closeLargeReportBtn">✕</button>
            </div>
            <div class="large-report-content" id="largeReportContent"></div>
        </div>
        
        <!-- ПРАВАЯ ПАНЕЛЬ (инфо о пайщике) -->
        <div class="sidebar-right" id="sidebarRight">
            <div class="member-info-header">
                <h3>Информация о пайщике</h3>
                <button class="close-info-btn" id="closeInfoBtn">✕</button>
            </div>
            <div class="member-info-content" id="memberInfoContent"></div>
        </div>
        
        <!-- ПРАВАЯ ПАНЕЛЬ (детали операции) -->
        <div class="operation-details-panel" id="operationDetailsPanel">
            <div class="details-header">
                <h3 id="detailsTitle">Детали операции</h3>
                <button class="close-details-btn" id="closeDetailsBtn">✕</button>
            </div>
            <div class="details-content" id="detailsContent"></div>
        </div>
        
        <!-- ПРАВАЯ ПАНЕЛЬ (контент левого меню) -->
        <div class="menu-content-panel" id="menuContentPanel">
            <div class="menu-panel-header">
                <h3 id="menuPanelTitle">Раздел</h3>
                <button class="close-panel-btn" id="closePanelBtn">✕</button>
            </div>
            <div class="menu-panel-content" id="menuPanelContent"></div>
        </div>
        
        <!-- FAB КНОПКА -->
        <div class="fab-container" id="fabContainer">
            <div class="fab-menu" id="fabMenu">
                <div class="fab-item" data-action="application">
                    <div class="fab-item-btn" style="background:#f44336">��</div>
                    <span class="fab-item-label">Заявление</span>
                </div>
                <div class="fab-item" data-action="document">
                    <div class="fab-item-btn" style="background:#9c27b0">📁</div>
                    <span class="fab-item-label">Документ</span>
                </div>
                <div class="fab-item" data-action="transaction">
                    <div class="fab-item-btn" style="background:#ff9800">📒</div>
                    <span class="fab-item-label">Проводка</span>
                </div>
                <div class="fab-item" data-action="payment">
                    <div class="fab-item-btn" style="background:#2196f3">💳</div>
                    <span class="fab-item-label">Взнос</span>
                </div>
                <div class="fab-item" data-action="member">
                    <div class="fab-item-btn" style="background:#4caf50">👤</div>
                    <span class="fab-item-label">Пайщик</span>
                </div>
            </div>
            <button class="fab-main" id="fabMain">+</button>
        </div>
    </div>

    <!-- ПАНЕЛЬ МАССОВЫХ ОПЕРАЦИЙ -->
    <div class="mass-actions-panel" id="massActionsPanel">
        <span class="mass-count" id="massCount">0 выбрано</span>
        <button onclick="massExport()">📊 Экспорт</button>
        <button onclick="massMessage()">✉️ Сообщение</button>
        <button onclick="clearMassSelection()">✕ Сброс</button>
    </div>

    <!-- Подключение внешних скриптов -->
    <!-- XLSX (с fallback на cdnjs) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        // Если основной CDN не загрузился, пробуем fallback
        if (typeof XLSX === 'undefined') {
            console.warn('SheetJS CDN не загрузился, пробуем fallback...');
            const fallback = document.createElement('script');
            fallback.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
            document.head.appendChild(fallback);
        }
    </script>

    <!-- Сначала Yandex Disk (должен загрузиться ПЕРЕД messenger-app-v2.js) -->
    <script src="yandex-disk-integration-v2.js?v=5.0.0"></script>

    <!-- Потом остальные скрипты -->
    <script src="app.js?v=5.0.0"></script>
    <script src="application_functions.js?v=5.0.0"></script>
    <script src="reports.js?v=5.0.0"></script>
    <script src="settings.js?v=5.0.0"></script>
    <script src="messenger-app-v2.js?v=5.0.0"></script>
    <script src="messenger-menu-handlers.js?v=5.0.0"></script>
    <script src="pdf_export.js?v=5.0.0"></script>
    
    <!-- Обработка токена Яндекс Диска -->
    <script>
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'YANDEX_TOKEN') {
                if (window.handleYandexToken) {
                    window.handleYandexToken(event.data.token);
                }
            }
        });
        
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('access_token');
        if (token) {
            if (window.handleYandexToken) {
                window.handleYandexToken(token);
            }
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>
    
    <!-- PANEL MANAGER & TELEGRAM INIT -->
    <script>
        // ============================================
        // TELEGRAM WEBAPP INIT
        // ============================================
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Применяем тему Telegram
        function applyTelegramTheme() {
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.backgroundColor || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.textColor || '#000000');
            document.documentElement.style.setProperty('--tg-theme-hint-color', tg.hintColor || '#999999');
            document.documentElement.style.setProperty('--tg-theme-button-color', tg.buttonColor || '#2481cc');
            document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.buttonTextColor || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.secondaryBackgroundColor || '#f0f2f5');
            
            // Устанавливаем цвета хедера
            tg.setHeaderColor(tg.themeParams.bg_color || '#ffffff');
            tg.setBottomBarColor(tg.themeParams.secondary_bg_color || '#f0f2f5');
        }

        // Применяем тему при загрузке
        applyTelegramTheme();

        // Слушим изменения темы
        tg.onEvent('themeChanged', () => {
            applyTelegramTheme();
        });

        // ============================================
        // ЯНДЕКС.ДИСК - АВТОМАТИЧЕСКАЯ ИНИЦИАЛИЗАЦИЯ
        // ============================================
        
        // Автоматическая инициализация Яндекс.Диска
        async function initYandexDiskAuto() {
            try {
                console.log('[Yandex] Начало инициализации...');
                
                // Проверяем токен
                const token = localStorage.getItem('yandexDiskToken');
                
                if (token) {
                    console.log('[Yandex] Токен найден, загружаем данные...');
                    
                    // Загружаем данные из Яндекс.Диска
                    if (typeof loadAllDataFromYandex === 'function') {
                        const result = await loadAllDataFromYandex();
                        if (result) {
                            console.log('[Yandex] Данные успешно загружены!');
                            
                            // Обновляем UI
                            if (typeof updateYandexDiskIndicator === 'function') {
                                updateYandexDiskIndicator();
                            }
                            
                            // Запускаем автосохранение
                            if (typeof startAutoSaveYandex === 'function') {
                                startAutoSaveYandex();
                            }
                        }
                    }
                } else {
                    console.log('[Yandex] Токен не найден. Ожидание авторизации...');
                }
                
            } catch (error) {
                console.error('[Yandex] Ошибка инициализации:', error.message);
            }
        }

        // Запускаем инициализацию после загрузки страницы
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                initYandexDiskAuto();
            }, 500);
        });

        // ============================================
        // ОБРАБОТКА ТОКЕНА ПОСЛЕ АВТОРИЗАЦИИ
        // ============================================
        
        // Обработка токена из Яндекс.Диска (после возврата из браузера)
        function handleYandexCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const hash = window.location.hash;
            
            let token = null;
            
            // Пробуем получить из hash
            if (hash && hash.includes('access_token')) {
                const hashParams = new URLSearchParams(hash.substring(1));
                token = hashParams.get('access_token');
            }
            
            // Пробуем получить из search
            if (!token && urlParams.get('access_token')) {
                token = urlParams.get('access_token');
            }
            
            if (token) {
                console.log('[Yandex] Токен получен из URL');
                
                // Сохраняем токен
                localStorage.setItem('yandexDiskToken', token);
                
                // Очищаем URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Показываем успех
                if (typeof showToast === 'function') {
                    showToast({
                        type: 'success',
                        message: '✓ Яндекс.Диск подключён!',
                        duration: 5000
                    });
                }
                
                // Тактильный отклик
                if (window.TelegramMiniApp) {
                    window.TelegramMiniApp.hapticFeedback('success');
                }
                
                // Загружаем данные
                setTimeout(() => {
                    initYandexDiskAuto();
                }, 1000);
            }
        }

        // Обработка сообщений от callback окна
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'YANDEX_TOKEN') {
                const token = event.data.token;
                if (token) {
                    console.log('[Yandex] Токен получен из postMessage');
                    
                    localStorage.setItem('yandexDiskToken', token);
                    
                    if (typeof showToast === 'function') {
                        showToast({
                            type: 'success',
                            message: '✓ Яндекс.Диск подключён!',
                            duration: 5000
                        });
                    }
                    
                    if (window.TelegramMiniApp) {
                        window.TelegramMiniApp.hapticFeedback('success');
                    }
                    
                    setTimeout(() => {
                        initYandexDiskAuto();
                    }, 1000);
                }
            }
        });

        // Вызываем обработку токена при загрузке
        window.addEventListener('load', () => {
            setTimeout(() => {
                handleYandexCallback();
            }, 500);
        });

        // ============================================
        // ЯНДЕКС.ДИСК ФУНКЦИИ
        // ============================================

        // Обработка клика по Яндекс.Диску
        function handleYandexDiskClick() {
            // Тактильный отклик для Telegram
            if (window.TelegramMiniApp) {
                window.TelegramMiniApp.hapticFeedback('light');
            }

            // Проверяем статус авторизации
            const token = localStorage.getItem('yandexDiskToken');
            const disabled = localStorage.getItem('yandexDiskDisabled') === 'true';

            if (disabled || !token) {
                // Показываем окно подключения
                showYandexDiskModal();
            } else {
                // Показываем меню синхронизации
                showYandexDiskMenu();
            }
        }

        // Показать окно подключения
        function showYandexDiskModal() {
            const content = `
                <div style="padding:40px;text-align:center;max-width:500px;margin:0 auto">
                    <div style="font-size:64px;margin-bottom:20px">☁️</div>
                    <h2 style="margin-bottom:10px;font-size:22px;font-weight:600">Яндекс Диск</h2>
                    <p style="color:#666;margin-bottom:30px;line-height:1.5">
                        Для надёжного хранения данных кооператива подключитесь к Яндекс Диску.
                        Данные будут автоматически сохраняться в папку "КООПЕРАНТ".
                    </p>
                    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:20px">
                        <button onclick="connectYandexDiskFromIndex()"
                                style="min-height:44px;padding:12px 24px;background:#fc0;color:#000;border:none;border-radius:12px;cursor:pointer;font-size:15px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:10px">
                            <span style="font-size:20px">☁️</span>
                            Войти через Яндекс
                        </button>
                        <button onclick="useLocalStorageFromIndex()"
                                style="min-height:44px;padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:12px;cursor:pointer;font-size:15px">
                            Работать без Яндекс Диска
                        </button>
                    </div>
                    <p style="font-size:12px;color:#999;margin-top:20px">
                        🔒 Ваши данные защищены и используются только для работы приложения
                    </p>
                </div>
            `;
            showModalYandex(content);
        }

        // Показать меню синхронизации
        function showYandexDiskMenu() {
            const content = `
                <div style="padding:30px;max-width:500px;margin:0 auto">
                    <div style="display:flex;align-items:center;gap:15px;margin-bottom:25px">
                        <div style="font-size:48px">☁️</div>
                        <div>
                            <h2 style="margin:0;font-size:20px;font-weight:600">Яндекс Диск</h2>
                            <p style="margin:5px 0 0;color:#666;font-size:14px">Синхронизация данных</p>
                        </div>
                    </div>
                    <div style="background:#f5f7fa;border-radius:12px;padding:20px;margin-bottom:20px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                            <span style="font-size:14px;color:#666">Статус</span>
                            <span style="display:flex;align-items:center;gap:8px">
                                <span class="yandex-indicator" style="width:10px;height:10px;display:inline-block"></span>
                                <span style="font-weight:600;color:#4caf50">Подключён</span>
                            </span>
                        </div>
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <span style="font-size:14px;color:#666">Автосохранение</span>
                            <span style="font-size:14px;font-weight:500;color:#4caf50">Включено (30 сек)</span>
                        </div>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:10px">
                        <button onclick="forceSyncFromIndex()" style="min-height:44px;padding:12px;background:#0088cc;color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:15px;font-weight:600">
                            🔄 Синхронизировать сейчас
                        </button>
                        <button onclick="createBackupFromIndex()" style="min-height:44px;padding:12px;background:#4caf50;color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:15px;font-weight:600">
                            💾 Создать резервную копию
                        </button>
                        <button onclick="logoutYandexFromIndex()" style="min-height:44px;padding:12px;background:#ffebee;color:#c62828;border:none;border-radius:12px;cursor:pointer;font-size:15px">
                            🚪 Выйти из Яндекс Диска
                        </button>
                        <button onclick="closeModalYandex()" style="min-height:44px;padding:12px;background:#f5f7fa;color:#333;border:none;border-radius:12px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;
            showModalYandex(content);
        }

        // Функции для кнопок
        window.connectYandexDiskFromIndex = async function() {
            if (typeof window.connectYandexDisk === 'function') {
                await window.connectYandexDisk();
            }
            closeModalYandex();
        };

        window.useLocalStorageFromIndex = function() {
            localStorage.setItem('yandexDiskDisabled', 'true');
            updateYandexDiskIndicator();
            closeModalYandex();
        };

        window.forceSyncFromIndex = async function() {
            if (typeof window.forceSyncYandex === 'function') {
                await window.forceSyncYandex();
            }
            closeModalYandex();
        };

        window.createBackupFromIndex = async function() {
            if (typeof window.createBackupYandex === 'function') {
                await window.createBackupYandex();
            }
            closeModalYandex();
        };

        window.logoutYandexFromIndex = function() {
            if (typeof window.logoutYandexDisk === 'function') {
                window.logoutYandexDisk();
                updateYandexDiskIndicator();
            }
            closeModalYandex();
        };

        // Обновить индикатор статуса
        function updateYandexDiskIndicator() {
            const indicator = document.getElementById('yandexIndicator');
            const text = document.getElementById('yandexDiskText');
            if (!indicator || !text) return;

            const token = localStorage.getItem('yandexDiskToken');
            const folderId = localStorage.getItem('yandexCooperativFolderId');
            const disabled = localStorage.getItem('yandexDiskDisabled') === 'true';

            if (disabled || !token || !folderId) {
                indicator.className = 'yandex-indicator disconnected';
                text.textContent = 'Яндекс Диск (отключён)';
            } else {
                indicator.className = 'yandex-indicator';
                text.textContent = 'Яндекс Диск';
            }
        }

        // Модальное окно
        function showModalYandex(content) {
            const existing = document.querySelector('.yandex-modal-overlay');
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.className = 'yandex-modal-overlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.2s ease;';

            const modal = document.createElement('div');
            modal.style.cssText = 'background:#fff;border-radius:16px;max-width:90%;max-height:90%;overflow-y:auto;animation:slideUp 0.3s ease;';
            modal.innerHTML = content;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            overlay.addEventListener('click', e => {
                if (e.target === overlay) closeModalYandex();
            });

            window.currentYandexModal = overlay;
        }

        // Делаем функцию доступной глобально для onclick из HTML
        window.closeModalYandex = function closeModalYandex() {
            if (window.currentYandexModal) {
                window.currentYandexModal.style.animation = 'fadeOut 0.2s ease';
                setTimeout(() => {
                    window.currentYandexModal.remove();
                    window.currentYandexModal = null;
                }, 200);
            }
        };

        // CSS анимации
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
            @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        `;
        document.head.appendChild(style);

        // Инициализация индикатора
        setTimeout(updateYandexDiskIndicator, 1000);

        // ============================================
        // PANEL MANAGER
        // ============================================
        const PanelManager = {
            currentPanel: null,
            overlay: null,  // Инициализируем позже
            
            // Инициализация
            init() {
                this.overlay = document.getElementById('panelOverlay');
                if (this.overlay) {
                    this.overlay.addEventListener('click', () => {
                        this.closeAll();
                    });
                }
            },

            open(panelId) {
                // Инициализируем если нужно
                if (!this.overlay) this.init();
                
                // Закрыть все открытые панели
                this.closeAll();

                // Открыть нужную
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.classList.add('visible');
                    if (this.overlay) {
                        this.overlay.classList.add('active');
                    }
                    this.currentPanel = panelId;

                    // Haptic feedback
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                }
            },

            close(panelId) {
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.classList.remove('visible');

                    // Если это была последняя панель, скрыть overlay
                    if (!document.querySelector('.panel.visible')) {
                        if (this.overlay) {
                            this.overlay.classList.remove('active');
                        }
                    }

                    this.currentPanel = null;
                }
            },

            closeAll() {
                document.querySelectorAll('.panel.visible').forEach(panel => {
                    panel.classList.remove('visible');
                });
                if (this.overlay) {
                    this.overlay.classList.remove('active');
                }
                this.currentPanel = null;
            }
        };
        
        // Инициализируем PanelManager
        PanelManager.init();
        
        // ============================================
        // SWIPE GESTURES
        // ============================================
        let touchStartX = 0;
        let touchEndX = 0;
        
        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });
        
        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });
        
        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            // Свайп вправо → закрыть панель
            if (diff < -swipeThreshold && PanelManager.currentPanel) {
                PanelManager.closeAll();
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
            }
        }
        
        // ============================================
        // ФУНКЦИИ ОБРАБОТКИ МЕНЮ (ГЛОБАЛЬНЫЕ)
        // ============================================
        
        // Открытие отчёта по имени
        window.openReportByName = function(reportName) {
            console.log('📊 Открытие отчёта:', reportName);
            
            // Обработка конкретных отчётов
            switch(reportName) {
                case 'members-registry-full':
                    showMembersRegistryReport();
                    break;
                    
                case 'calendar-full':
                    showCalendarReport();
                    break;
                    
                case 'payments-report-full':
                    showPaymentsReport();
                    break;
                    
                case 'balance':
                    showBalanceReport();
                    break;
                    
                case 'osv':
                    showOSVReport();
                    break;
                    
                case 'kudir':
                    showKUDiRReport();
                    break;
                    
                case 'profit-loss':
                    showProfitLossReport();
                    break;
                    
                case 'rsv':
                    showRSVReport();
                    break;
                    
                case 'szv-stazh':
                    showSZVSTAZHReport();
                    break;
                    
                case '6-ndfl':
                    show6NDFLReport();
                    break;
                    
                default:
                    // Показываем уведомление для остальных отчётов
                    if (typeof window.showToast === 'function') {
                        window.showToast({
                            type: 'info',
                            message: 'Отчёт "' + reportName + '" в разработке',
                            duration: 3000
                        });
                    } else {
                        alert('Отчёт: ' + reportName + ' (в разработке)');
                    }
            }
        };
        
        // ============================================
        // ОТЧЁТ: РЕЕСТР ПАЙЩИКОВ
        // ============================================
        
        // Показать реестр пайщиков
        window.showMembersRegistryReport = function() {
            const members = JSON.parse(localStorage.getItem('members') || '[]');
            
            let tableHTML = '';
            
            if (members.length === 0) {
                tableHTML = '<div style="padding:40px;text-align:center;color:#999">📭 Список пайщиков пуст</div>';
            } else {
                tableHTML = `
                    <table style="width:100%;border-collapse:collapse;font-size:14px">
                        <thead>
                            <tr style="background:#f5f7fa">
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #ddd">№</th>
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #ddd">ФИО</th>
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #ddd">Телефон</th>
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #ddd">Email</th>
                                <th style="padding:12px;text-align:right;border-bottom:2px solid #ddd">Взнос (₽)</th>
                                <th style="padding:12px;text-align:center;border-bottom:2px solid #ddd">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                members.forEach((member, index) => {
                    tableHTML += `
                        <tr style="border-bottom:1px solid #eee">
                            <td style="padding:12px;color:#999">${index + 1}</td>
                            <td style="padding:12px;font-weight:500">${member.name || '—'}</td>
                            <td style="padding:12px;color:#666">${member.phone || '—'}</td>
                            <td style="padding:12px;color:#666">${member.email || '—'}</td>
                            <td style="padding:12px;text-align:right;font-weight:600;color:#0088cc">${(member.entranceFee || 0).toLocaleString()}</td>
                            <td style="padding:12px;text-align:center">
                                <button onclick="editMember(${member.id})" 
                                        style="padding:6px 12px;background:#2196f3;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;margin-right:4px"
                                        title="Редактировать">
                                    ✏️
                                </button>
                                <button onclick="deleteMember(${member.id})" 
                                        style="padding:6px 12px;background:#f44336;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px"
                                        title="Удалить">
                                    🗑️
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                        </tbody>
                        <tfoot>
                            <tr style="background:#f5f7fa;font-weight:600">
                                <td colspan="4" style="padding:12px;text-align:right">Итого:</td>
                                <td style="padding:12px;text-align:right;color:#0088cc">${members.reduce((sum, m) => sum + (m.entranceFee || 0), 0).toLocaleString()} ₽</td>
                                <td style="padding:12px;text-align:center">${members.length} чел.</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            }
            
            const content = `
                <div style="padding:30px;max-width:900px;margin:0 auto">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                        <h2 style="font-size:20px;font-weight:600">📋 Реестр пайщиков</h2>
                        <button onclick="window.showCreateMemberModal()" 
                                style="padding:10px 20px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600">
                            ➕ Добавить
                        </button>
                    </div>
                    
                    ${tableHTML}
                    
                    <div style="margin-top:20px;text-align:center">
                        <button onclick="closeModalYandex()" 
                                style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;
            
            showModalYandex(content);
        };
        
        // ============================================
        // РЕДАКТИРОВАНИЕ ПАЙЩИКА
        // ============================================
        
        // Редактировать пайщика
        window.editMember = function(memberId) {
            const members = JSON.parse(localStorage.getItem('members') || '[]');
            const member = members.find(m => m.id == memberId);
            
            if (!member) {
                alert('Пайщик не найден!');
                return;
            }
            
            const content = `
                <div style="padding:30px;max-width:600px;margin:0 auto">
                    <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">✏️ Редактировать пайщика</h2>
                    
                    <form id="editMemberForm" onsubmit="return handleEditMember(event, ${memberId})">
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">ФИО *</label>
                            <input type="text" name="name" required value="${member.name || ''}"
                                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>
                        
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Телефон</label>
                            <input type="tel" name="phone" value="${member.phone || ''}"
                                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>
                        
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Email</label>
                            <input type="email" name="email" value="${member.email || ''}"
                                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>
                        
                        <div style="margin-bottom:20px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Вступительный взнос (₽)</label>
                            <input type="number" name="entranceFee" value="${member.entranceFee || 0}"
                                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>
                        
                        <div style="display:flex;gap:10px;justify-content:flex-end">
                            <button type="button" onclick="closeModalYandex()" 
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Отмена
                            </button>
                            <button type="submit" 
                                    style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                💾 Сохранить
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModalYandex(content);
        };
        
        // Обработка сохранения редактирования
        window.handleEditMember = function(event, memberId) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const members = JSON.parse(localStorage.getItem('members') || '[]');
            const index = members.findIndex(m => m.id == memberId);
            
            if (index === -1) {
                alert('Пайщик не найден!');
                return false;
            }
            
            // Обновляем данные
            members[index].name = formData.get('name');
            members[index].phone = formData.get('phone');
            members[index].email = formData.get('email');
            members[index].entranceFee = parseFloat(formData.get('entranceFee')) || 0;
            members[index].updatedAt = new Date().toISOString();
            
            // Сохраняем
            localStorage.setItem('members', JSON.stringify(members));
            
            // Закрываем модальное окно
            closeModalYandex();
            
            // Показываем уведомление
            if (typeof window.showToast === 'function') {
                window.showToast({
                    type: 'success',
                    message: `✅ Пайщик "${members[index].name}" обновлён!`,
                    duration: 3000
                });
            }
            
            // Тактильный отклик
            if (window.TelegramMiniApp) {
                window.TelegramMiniApp.hapticFeedback('success');
            }
            
            // Обновляем реестр
            setTimeout(() => {
                window.showMembersRegistryReport();
            }, 500);
            
            return false;
        };
        
        // Удалить пайщика
        window.deleteMember = function(memberId) {
            if (!confirm('Вы уверены, что хотите удалить этого пайщика? Это действие нельзя отменить.')) {
                return;
            }
            
            const members = JSON.parse(localStorage.getItem('members') || '[]');
            const filtered = members.filter(m => m.id != memberId);
            
            if (filtered.length === members.length) {
                alert('Пайщик не найден!');
                return;
            }
            
            // Сохраняем
            localStorage.setItem('members', JSON.stringify(filtered));
            
            // Показываем уведомление
            if (typeof window.showToast === 'function') {
                window.showToast({
                    type: 'success',
                    message: '✅ Пайщик удалён',
                    duration: 3000
                });
            }
            
            // Тактильный отклик
            if (window.TelegramMiniApp) {
                window.TelegramMiniApp.hapticFeedback('success');
            }
            
            // Обновляем реестр
            setTimeout(() => {
                window.showMembersRegistryReport();
            }, 500);
        };
        
        // ============================================
        // ОТЧЁТ: КАЛЕНДАРЬ СОБЫТИЙ
        // ============================================
        
        // Показать календарь событий
        window.showCalendarReport = function() {
            // Генерируем события на текущий месяц
            const today = new Date();
            const currentMonth = today.toLocaleString('ru', { month: 'long', year: 'numeric' });
            
            // Примеры событий
            const events = [
                { date: '01.03.2026', title: 'Общее собрание пайщиков', type: 'meeting' },
                { date: '05.03.2026', title: 'Срок уплаты членских взносов', type: 'payment' },
                { date: '10.03.2026', title: 'Заседание правления', type: 'meeting' },
                { date: '15.03.2026', title: 'Срок подачи отчётности', type: 'report' },
                { date: '20.03.2026', title: 'Выплата дивидендов', type: 'payment' },
                { date: '28.03.2026', title: 'Срок уплаты УСН', type: 'tax' },
                { date: '31.03.2026', title: 'Квартальный отчёт', type: 'report' }
            ];
            
            const typeColors = {
                meeting: '#0088cc',
                payment: '#4caf50',
                report: '#ff9800',
                tax: '#f44336'
            };
            
            const typeLabels = {
                meeting: '📋 Собрание',
                payment: '💳 Платёж',
                report: '📊 Отчёт',
                tax: '💰 Налог'
            };
            
            let eventsHTML = '';
            
            events.forEach(event => {
                eventsHTML += `
                    <div style="display:flex;align-items:center;padding:12px;border-bottom:1px solid #eee">
                        <div style="width:60px;text-align:center;font-weight:600;color:#0088cc">${event.date.split('.')[0]}</div>
                        <div style="flex:1;padding-left:12px">
                            <div style="font-weight:500">${event.title}</div>
                            <div style="font-size:12px;color:#999;margin-top:4px">
                                <span style="display:inline-block;padding:2px 8px;background:${typeColors[event.type]}20;color:${typeColors[event.type]};border-radius:4px;font-size:11px">
                                    ${typeLabels[event.type]}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            const content = `
                <div style="padding:30px;max-width:700px;margin:0 auto">
                    <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">📅 Календарь событий</h2>
                    
                    <div style="background:#f5f7fa;padding:15px;border-radius:8px;margin-bottom:20px">
                        <div style="font-size:16px;font-weight:600;text-align:center">📆 ${currentMonth}</div>
                    </div>
                    
                    <div style="border:1px solid #eee;border-radius:8px;overflow:hidden">
                        ${eventsHTML}
                    </div>
                    
                    <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap">
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="width:12px;height:12px;background:#0088cc20;border-radius:2px"></span>
                            <span style="font-size:12px">Собрание</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="width:12px;height:12px;background:#4caf5020;border-radius:2px"></span>
                            <span style="font-size:12px">Платёж</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="width:12px;height:12px;background:#ff980020;border-radius:2px"></span>
                            <span style="font-size:12px">Отчёт</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="width:12px;height:12px;background:#f4433620;border-radius:2px"></span>
                            <span style="font-size:12px">Налог</span>
                        </div>
                    </div>
                    
                    <div style="margin-top:20px;text-align:center">
                        <button onclick="closeModalYandex()" 
                                style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;
            
            showModalYandex(content);
        };
        
        // ============================================
        // ОТЧЁТ: ОТЧЁТ ПО ВЗНОСАМ
        // ============================================
        
        // Показать отчёт по взносам
        window.showPaymentsReport = function() {
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');
            
            // Группируем по типам
            const byType = {
                entrance: { label: 'Вступительные', count: 0, sum: 0 },
                membership: { label: 'Членские', count: 0, sum: 0 },
                share: { label: 'Паевые', count: 0, sum: 0 },
                additional: { label: 'Дополнительные', count: 0, sum: 0 }
            };
            
            let totalSum = 0;
            
            payments.forEach(payment => {
                if (byType[payment.type]) {
                    byType[payment.type].count++;
                    byType[payment.type].sum += payment.amount;
                    totalSum += payment.amount;
                }
            });
            
            let rowsHTML = '';
            
            Object.keys(byType).forEach(key => {
                const item = byType[key];
                rowsHTML += `
                    <tr style="border-bottom:1px solid #eee">
                        <td style="padding:12px">${item.label}</td>
                        <td style="padding:12px;text-align:center">${item.count}</td>
                        <td style="padding:12px;text-align:right;font-weight:600;color:#0088cc">${item.sum.toLocaleString()} ₽</td>
                    </tr>
                `;
            });
            
            const content = `
                <div style="padding:30px;max-width:700px;margin:0 auto">
                    <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">💳 Отчёт по взносам</h2>
                    
                    <table style="width:100%;border-collapse:collapse;font-size:14px;margin-bottom:20px">
                        <thead>
                            <tr style="background:#f5f7fa">
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #ddd">Тип взносов</th>
                                <th style="padding:12px;text-align:center;border-bottom:2px solid #ddd">Кол-во</th>
                                <th style="padding:12px;text-align:right;border-bottom:2px solid #ddd">Сумма</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHTML}
                        </tbody>
                        <tfoot>
                            <tr style="background:#f5f7fa;font-weight:600">
                                <td style="padding:12px">Итого:</td>
                                <td style="padding:12px;text-align:center">${payments.length}</td>
                                <td style="padding:12px;text-align:right;color:#0088cc">${totalSum.toLocaleString()} ₽</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div style="margin-top:20px">
                        <button onclick="showPaymentsList()" 
                                style="padding:10px 20px;background:#2196f3;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px">
                            📋 Показать все взносы
                        </button>
                    </div>
                    
                    <div style="margin-top:20px;text-align:center">
                        <button onclick="closeModalYandex()" 
                                style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;
            
            showModalYandex(content);
        };
        
        // Показать список всех взносов
        window.showPaymentsList = function() {
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');
            
            let rowsHTML = '';
            
            if (payments.length === 0) {
                rowsHTML = '<tr><td colspan="7" style="padding:40px;text-align:center;color:#999">📭 Взносов нет</td></tr>';
            } else {
                payments.forEach(payment => {
                    const typeLabels = {
                        entrance: 'Вступительный',
                        membership: 'Членский',
                        share: 'Паевой',
                        additional: 'Дополнительный'
                    };
                    
                    rowsHTML += `
                        <tr style="border-bottom:1px solid #eee">
                            <td style="padding:12px">${payment.memberName || '—'}</td>
                            <td style="padding:12px">${typeLabels[payment.type] || payment.type}</td>
                            <td style="padding:12px;text-align:right;font-weight:600;color:#0088cc">${payment.amount.toLocaleString()} ₽</td>
                            <td style="padding:12px;text-align:center">${payment.date || '—'}</td>
                            <td style="padding:12px">${payment.description || '—'}</td>
                            <td style="padding:12px;text-align:center">
                                <button onclick="editPayment(${payment.id})" 
                                        style="padding:6px 12px;background:#2196f3;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;margin-right:4px"
                                        title="Редактировать">
                                    ✏️
                                </button>
                                <button onclick="deletePayment(${payment.id})" 
                                        style="padding:6px 12px;background:#f44336;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px"
                                        title="Удалить">
                                    🗑️
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            const content = `
                <div style="padding:30px;max-width:1000px;margin:0 auto">
                    <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">📋 Все взносы</h2>
                    
                    <table style="width:100%;border-collapse:collapse;font-size:13px">
                        <thead>
                            <tr style="background:#f5f7fa">
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #ddd">Пайщик</th>
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #ddd">Тип</th>
                                <th style="padding:12px;text-align:right;border-bottom:2px solid #ddd">Сумма</th>
                                <th style="padding:12px;text-align:center;border-bottom:2px solid #ddd">Дата</th>
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #ddd">Назначение</th>
                                <th style="padding:12px;text-align:center;border-bottom:2px solid #ddd">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHTML}
                        </tbody>
                    </table>
                    
                    <div style="margin-top:20px;text-align:center">
                        <button onclick="closeModalYandex()" 
                                style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;
            
            showModalYandex(content);
        };
        
        // Редактировать взнос
        window.editPayment = function(paymentId) {
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');
            const payment = payments.find(p => p.id == paymentId);
            
            if (!payment) {
                alert('Взнос не найден!');
                return;
            }
            
            const members = JSON.parse(localStorage.getItem('members') || '[]');
            
            let memberOptions = '<option value="">Выберите пайщика</option>';
            members.forEach(member => {
                const selected = member.id == payment.memberId ? 'selected' : '';
                memberOptions += `<option value="${member.id}" ${selected}>${member.name}</option>`;
            });
            
            const content = `
                <div style="padding:30px;max-width:600px;margin:0 auto">
                    <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">✏️ Редактировать взнос</h2>
                    
                    <form id="editPaymentForm" onsubmit="return handleEditPayment(event, ${paymentId})">
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Пайщик *</label>
                            <select name="memberId" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                ${memberOptions}
                            </select>
                        </div>
                        
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Тип взноса *</label>
                            <select name="type" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                <option value="entrance" ${payment.type === 'entrance' ? 'selected' : ''}>Вступительный</option>
                                <option value="membership" ${payment.type === 'membership' ? 'selected' : ''}>Членский</option>
                                <option value="share" ${payment.type === 'share' ? 'selected' : ''}>Паевой</option>
                                <option value="additional" ${payment.type === 'additional' ? 'selected' : ''}>Дополнительный</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Сумма (₽) *</label>
                            <input type="number" name="amount" required min="1" step="0.01" value="${payment.amount}"
                                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>
                        
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Дата</label>
                            <input type="date" name="date" value="${payment.date || ''}"
                                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>
                        
                        <div style="margin-bottom:20px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Назначение</label>
                            <textarea name="description" rows="3" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">${payment.description || ''}</textarea>
                        </div>
                        
                        <div style="display:flex;gap:10px;justify-content:flex-end">
                            <button type="button" onclick="closeModalYandex()" 
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Отмена
                            </button>
                            <button type="submit" 
                                    style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                💾 Сохранить
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModalYandex(content);
        };
        
        // Обработка сохранения редактирования взноса
        window.handleEditPayment = function(event, paymentId) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');
            const index = payments.findIndex(p => p.id == paymentId);
            
            if (index === -1) {
                alert('Взнос не найден!');
                return false;
            }
            
            // Обновляем да����ные
            payments[index].memberId = formData.get('memberId');
            payments[index].type = formData.get('type');
            payments[index].amount = parseFloat(formData.get('amount'));
            payments[index].date = formData.get('date');
            payments[index].description = formData.get('description');
            payments[index].updatedAt = new Date().toISOString();
            
            // Находим имя пайщика
            const members = JSON.parse(localStorage.getItem('members') || '[]');
            const member = members.find(m => m.id == payments[index].memberId);
            payments[index].memberName = member ? member.name : 'Неизвестно';
            
            // Сохраняем
            localStorage.setItem('payments', JSON.stringify(payments));
            
            // Закрываем модальное окно
            closeModalYandex();
            
            // Показываем уведомление
            if (typeof window.showToast === 'function') {
                window.showToast({
                    type: 'success',
                    message: `✅ Взнос "${payments[index].memberName}" обновлён!`,
                    duration: 3000
                });
            }
            
            // Тактильный отклик
            if (window.TelegramMiniApp) {
                window.TelegramMiniApp.hapticFeedback('success');
            }
            
            // Обновляем список
            setTimeout(() => {
                window.showPaymentsList();
            }, 500);
            
            return false;
        };
        
        // Удалить взнос
        window.deletePayment = function(paymentId) {
            if (!confirm('Вы уверены, что хотите удалить этот взнос? Это действие нельзя отменить.')) {
                return;
            }
            
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');
            const filtered = payments.filter(p => p.id != paymentId);
            
            if (filtered.length === payments.length) {
                alert('Взнос не найден!');
                return;
            }
            
            // Сохраняем
            localStorage.setItem('payments', JSON.stringify(filtered));
            
            // Показываем уведомление
            if (typeof window.showToast === 'function') {
                window.showToast({
                    type: 'success',
                    message: '✅ Взнос удалён',
                    duration: 3000
                });
            }
            
            // Тактильный отклик
            if (window.TelegramMiniApp) {
                window.TelegramMiniApp.hapticFeedback('success');
            }
            
            // Обновляем список
            setTimeout(() => {
                window.showPaymentsList();
            }, 500);
        };
        
        // ============================================
        // ОТЧЁТ: БУХГАЛТЕРСКИЙ БАЛАНС (ФОРМА №1)
        // ============================================

        // Показать бухгалтерский баланс
        window.showBalanceReport = function() {
            // Получаем реальные данные из проводок и платежей
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');
            const members = JSON.parse(localStorage.getItem('members') || '[]');

            // Считаем остатки по счетам из проводок
            const balances = {};
            transactions.forEach(t => {
                // Дебет
                if (!balances[t.debitAccount]) balances[t.debitAccount] = 0;
                balances[t.debitAccount] += t.amount;
                
                // Кредит
                if (!balances[t.creditAccount]) balances[t.creditAccount] = 0;
                balances[t.creditAccount] -= t.amount;
            });

            // Рассчитываем статьи баланса
            const cash = Math.abs(balances['50'] || 0) + Math.abs(balances['51'] || 0); // Денежные средства
            const loansIssued = Math.abs(balances['58'] || 0); // Финансовые вложения (займы)
            const fixedAssets = Math.abs(balances['01'] || 0); // Основные средства
            const materials = Math.abs(balances['10'] || 0); // Материалы
            const receivables = Math.abs(balances['60'] || 0) + Math.abs(balances['62'] || 0) + Math.abs(balances['76'] || 0); // Дебиторка
            
            const totalCurrentAssets = cash + materials + receivables;
            const totalNonCurrentAssets = loansIssued + fixedAssets;
            const totalAssets = totalCurrentAssets + totalNonCurrentAssets;

            // Пассивы
            const authorizedCapital = members.length * 1000; // Уставный капитал (по 1000₽ на пайщика)
            const totalContributions = payments.reduce((sum, p) => sum + p.amount, 0); // Целевое финансирование
            const reserveCapital = Math.abs(balances['82'] || 0); // Резервный капитал
            const retainedEarnings = totalContributions - totalAssets; // Нераспределённая прибыль (балансировка)
            
            const totalCapital = authorizedCapital + totalContributions + reserveCapital + retainedEarnings;
            const totalLiabilities = totalCapital;

            const content = `
                <div style="padding:30px;max-width:800px;margin:0 auto">
                    <h2 style="margin-bottom:10px;font-size:20px;font-weight:600;text-align:center">⚖️ Бухгалтерский баланс</h2>
                    <p style="text-align:center;color:#999;margin-bottom:20px">Форма №1 (ОКУД 0710001)</p>
                    <p style="text-align:center;color:#666;margin-bottom:20px">На ${new Date().toLocaleDateString('ru')}</p>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
                        <!-- АКТИВ -->
                        <div style="border:1px solid #ddd;border-radius:8px;overflow:hidden">
                            <div style="background:#0088cc;color:#fff;padding:12px;text-align:center;font-weight:600">АКТИВ</div>

                            <div style="padding:12px;border-bottom:1px solid #eee;background:#f9f9f9">
                                <div style="display:flex;justify-content:space-between">
                                    <span>Внеоборотные активы</span>
                                    <span style="font-weight:600">${totalNonCurrentAssets.toLocaleString()} ₽</span>
                                </div>
                            </div>

                            <div style="padding:12px;border-bottom:1px solid #eee">
                                <div style="display:flex;justify-content:space-between">
                                    <span>Оборотные активы</span>
                                    <span style="font-weight:600">${totalCurrentAssets.toLocaleString()} ₽</span>
                                </div>
                            </div>

                            <div style="padding:12px;background:#0088cc10;font-weight:600">
                                <div style="display:flex;justify-content:space-between">
                                    <span>БАЛАНС</span>
                                    <span style="color:#0088cc">${totalAssets.toLocaleString()} ₽</span>
                                </div>
                            </div>
                        </div>

                        <!-- ПАССИВ -->
                        <div style="border:1px solid #ddd;border-radius:8px;overflow:hidden">
                            <div style="background:#4caf50;color:#fff;padding:12px;text-align:center;font-weight:600">ПАССИВ</div>

                            <div style="padding:12px;border-bottom:1px solid #eee;background:#f9f9f9">
                                <div style="display:flex;justify-content:space-between">
                                    <span>Уставный капитал</span>
                                    <span style="font-weight:600">${authorizedCapital.toLocaleString()} ₽</span>
                                </div>
                            </div>

                            <div style="padding:12px;border-bottom:1px solid #eee">
                                <div style="display:flex;justify-content:space-between">
                                    <span>Целевое финансирование (взносы)</span>
                                    <span style="font-weight:600">${totalContributions.toLocaleString()} ₽</span>
                                </div>
                            </div>

                            <div style="padding:12px;border-bottom:1px solid #eee">
                                <div style="display:flex;justify-content:space-between">
                                    <span>Резервный капитал</span>
                                    <span style="font-weight:600">${reserveCapital.toLocaleString()} ₽</span>
                                </div>
                            </div>

                            <div style="padding:12px;border-bottom:1px solid #eee">
                                <div style="display:flex;justify-content:space-between">
                                    <span>Нераспределённая прибыль</span>
                                    <span style="font-weight:600">${retainedEarnings.toLocaleString()} ₽</span>
                                </div>
                            </div>

                            <div style="padding:12px;background:#4caf5010;font-weight:600">
                                <div style="display:flex;justify-content:space-between">
                                    <span>БАЛАНС</span>
                                    <span style="color:#4caf50">${totalLiabilities.toLocaleString()} ₽</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="text-align:center;padding:15px;background:${totalAssets === totalLiabilities ? '#e8f5e9' : '#ffebee'};border-radius:8px">
                        <div style="font-size:14px;color:#666">Активы = Пассивы</div>
                        <div style="font-size:24px;font-weight:700;color:${totalAssets === totalLiabilities ? '#4caf50' : '#f44336'}">
                            ${totalAssets === totalLiabilities ? '✅' : '⚠️'} ${totalAssets.toLocaleString()} ₽ = ${totalLiabilities.toLocaleString()} ₽
                        </div>
                    </div>

                    <div style="margin-top:20px;text-align:center">
                        <button onclick="closeModalYandex()"
                                style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;

            showModalYandex(content);
        };
        
        // ============================================
        // ОТЧЁТ: ОСВ (ОБОРОТНО-САЛЬДОВАЯ ВЕДОМОСТЬ)
        // ============================================
        
        // Показать ОСВ
        window.showOSVReport = function() {
            // Получаем реальные данные из проводок
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            const chartOfAccounts = window.chartOfAccounts || [];

            // Считаем обороты по счетам
            const accounts = {};
            
            transactions.forEach(t => {
                // Дебет
                if (!accounts[t.debitAccount]) {
                    const accInfo = chartOfAccounts.find(a => a.code === t.debitAccount);
                    accounts[t.debitAccount] = {
                        name: accInfo ? accInfo.name : t.debitAccount,
                        debitTurn: 0,
                        creditTurn: 0
                    };
                }
                accounts[t.debitAccount].debitTurn += t.amount;
                
                // Кредит
                if (!accounts[t.creditAccount]) {
                    const accInfo = chartOfAccounts.find(a => a.code === t.creditAccount);
                    accounts[t.creditAccount] = {
                        name: accInfo ? accInfo.name : t.creditAccount,
                        debitTurn: 0,
                        creditTurn: 0
                    };
                }
                accounts[t.creditAccount].creditTurn += t.amount;
            });

            // Преобразуем в массив для таблицы
            const osvData = Object.keys(accounts).map(code => ({
                account: code,
                name: accounts[code].name,
                debitStart: 0, // Для упрощения считаем с нуля
                creditStart: 0,
                debitTurn: accounts[code].debitTurn,
                creditTurn: accounts[code].creditTurn,
                debitEnd: accounts[code].debitTurn, // Для активных счетов
                creditEnd: accounts[code].creditTurn // Для пассивных счетов
            })).sort((a, b) => a.account.localeCompare(b.account));

            let rowsHTML = '';

            osvData.forEach(row => {
                rowsHTML += `
                    <tr style="border-bottom:1px solid #eee">
                        <td style="padding:10px;font-weight:600">${row.account}</td>
                        <td style="padding:10px">${row.name}</td>
                        <td style="padding:10px;text-align:right">${row.debitStart.toLocaleString()}</td>
                        <td style="padding:10px;text-align:right">${row.creditStart.toLocaleString()}</td>
                        <td style="padding:10px;text-align:right">${row.debitTurn.toLocaleString()}</td>
                        <td style="padding:10px;text-align:right">${row.creditTurn.toLocaleString()}</td>
                        <td style="padding:10px;text-align:right">${row.debitEnd.toLocaleString()}</td>
                        <td style="padding:10px;text-align:right">${row.creditEnd.toLocaleString()}</td>
                    </tr>
                `;
            });

            const totals = osvData.reduce((acc, row) => ({
                debitStart: acc.debitStart + row.debitStart,
                creditStart: acc.creditStart + row.creditStart,
                debitTurn: acc.debitTurn + row.debitTurn,
                creditTurn: acc.creditTurn + row.creditTurn,
                debitEnd: acc.debitEnd + row.debitEnd,
                creditEnd: acc.creditEnd + row.creditEnd
            }), { debitStart: 0, creditStart: 0, debitTurn: 0, creditTurn: 0, debitEnd: 0, creditEnd: 0 });

            const content = `
                <div style="padding:30px;max-width:1000px;margin:0 auto;overflow-x:auto">
                    <h2 style="margin-bottom:10px;font-size:20px;font-weight:600;text-align:center">📊 Оборотно-сальдовая ведомость</h2>
                    <p style="text-align:center;color:#999;margin-bottom:20px">по счетам бухгалтерского учёта</p>
                    <p style="text-align:center;color:#666;margin-bottom:20px">На ${new Date().toLocaleDateString('ru')}</p>

                    <table style="width:100%;border-collapse:collapse;font-size:12px">
                        <thead>
                            <tr style="background:#f5f7fa">
                                <th style="padding:10px;border:1px solid #ddd;text-align:center" rowspan="2">Счёт</th>
                                <th style="padding:10px;border:1px solid #ddd;text-align:left" rowspan="2">Наименование</th>
                                <th style="padding:10px;border:1px solid #ddd;text-align:center" colspan="2">Остаток на начало</th>
                                <th style="padding:10px;border:1px solid #ddd;text-align:center" colspan="2">Обороты</th>
                                <th style="padding:10px;border:1px solid #ddd;text-align:center" colspan="2">Остаток на конец</th>
                            </tr>
                            <tr style="background:#f5f7fa">
                                <th style="padding:8px;border:1px solid #ddd;text-align:right">Дт</th>
                                <th style="padding:8px;border:1px solid #ddd;text-align:right">Кт</th>
                                <th style="padding:8px;border:1px solid #ddd;text-align:right">Дт</th>
                                <th style="padding:8px;border:1px solid #ddd;text-align:right">Кт</th>
                                <th style="padding:8px;border:1px solid #ddd;text-align:right">Дт</th>
                                <th style="padding:8px;border:1px solid #ddd;text-align:right">Кт</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHTML}
                        </tbody>
                        <tfoot>
                            <tr style="background:#f5f7fa;font-weight:600">
                                <td style="padding:10px;border:1px solid #ddd;text-align:center" colspan="2">ИТОГО:</td>
                                <td style="padding:10px;border:1px solid #ddd;text-align:right">${totals.debitStart.toLocaleString()}</td>
                                <td style="padding:10px;border:1px solid #ddd;text-align:right">${totals.creditStart.toLocaleString()}</td>
                                <td style="padding:10px;border:1px solid #ddd;text-align:right">${totals.debitTurn.toLocaleString()}</td>
                                <td style="padding:10px;border:1px solid #ddd;text-align:right">${totals.creditTurn.toLocaleString()}</td>
                                <td style="padding:10px;border:1px solid #ddd;text-align:right">${totals.debitEnd.toLocaleString()}</td>
                                <td style="padding:10px;border:1px solid #ddd;text-align:right">${totals.creditEnd.toLocaleString()}</td>
                            </tr>
                        </tfoot>
                    </table>

                    <div style="margin-top:20px;text-align:center">
                        <button onclick="closeModalYandex()"
                                style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;

            showModalYandex(content);
        };
        
        // ============================================
        // ОТЧЁТ: КУДиР УСН (КНИГА УЧЁТА ДОХОДОВ И РАСХОДОВ)
        // ============================================
        
        // Показать КУДиР
        window.showKUDiRReport = function() {
            const currentYear = new Date().getFullYear();
            
            // Получаем данные из проводок и платежей
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');
            
            // Фильтруем за текущий год
            const yearTransactions = transactions.filter(t => t.date.startsWith(currentYear));
            const yearPayments = payments.filter(p => p.date.startsWith(currentYear));
            
            // Доходы (вступительные, паевые, членские взносы)
            const incomes = yearPayments.filter(p => ['entrance', 'share', 'membership'].includes(p.type));
            const totalIncomes = incomes.reduce((sum, p) => sum + p.amount, 0);
            
            // Расходы (из проводок по счетам 20, 26, 44)
            const expenseAccounts = ['20', '26', '44'];
            const expenses = yearTransactions.filter(t => expenseAccounts.includes(t.creditAccount));
            const totalExpenses = expenses.reduce((sum, t) => sum + t.amount, 0);
            
            // Финансовый результат
            const financialResult = totalIncomes - totalExpenses;
            
            let incomeRowsHTML = '';
            if (incomes.length === 0) {
                incomeRowsHTML = '<tr><td colspan="4" style="padding:12px;text-align:center;color:#999">Доходов нет</td></tr>';
            } else {
                incomes.forEach((inc, idx) => {
                    incomeRowsHTML += `
                        <tr style="border-bottom:1px solid #eee">
                            <td style="padding:10px;text-align:center">${idx + 1}</td>
                            <td style="padding:10px">${inc.date || '—'}</td>
                            <td style="padding:10px">${inc.memberName || '—'}</td>
                            <td style="padding:10px;text-align:right;font-weight:600;color:#4caf50">${inc.amount.toLocaleString()} ₽</td>
                        </tr>
                    `;
                });
            }
            
            const content = `
                <div style="padding:30px;max-width:900px;margin:0 auto">
                    <h2 style="margin-bottom:10px;font-size:20px;font-weight:600;text-align:center">📊 КУДиР УСН</h2>
                    <p style="text-align:center;color:#999;margin-bottom:20px">Книга учёта доходов и расходов за ${currentYear} год</p>
                    
                    <div style="background:#f5f7fa;padding:15px;border-radius:8px;margin-bottom:20px">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
                            <div style="text-align:center">
                                <div style="font-size:14px;color:#666">Доходы</div>
                                <div style="font-size:24px;font-weight:700;color:#4caf50">${totalIncomes.toLocaleString()} ₽</div>
                            </div>
                            <div style="text-align:center">
                                <div style="font-size:14px;color:#666">Расходы</div>
                                <div style="font-size:24px;font-weight:700;color:#f44336">${totalExpenses.toLocaleString()} ₽</div>
                            </div>
                        </div>
                        <div style="text-align:center;margin-top:15px;padding-top:15px;border-top:2px solid #ddd">
                            <div style="font-size:16px;font-weight:600">Налоговая база</div>
                            <div style="font-size:28px;font-weight:700;color:${financialResult >= 0 ? '#0088cc' : '#f44336'}">
                                ${financialResult >= 0 ? '+' : ''}${financialResult.toLocaleString()} ₽
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom:15px;font-size:16px;font-weight:600">📈 Доходы кооператива</h3>
                    
                    <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:20px">
                        <thead>
                            <tr style="background:#f5f7fa">
                                <th style="padding:10px;border:1px solid #ddd;text-align:center" rowspan="2">№</th>
                                <th style="padding:10px;border:1px solid #ddd;text-align:center" rowspan="2">Дата</th>
                                <th style="padding:10px;border:1px solid #ddd;text-align:left" rowspan="2">Содержание операции</th>
                                <th style="padding:10px;border:1px solid #ddd;text-align:right" rowspan="2">Сумма</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${incomeRowsHTML}
                        </tbody>
                        <tfoot>
                            <tr style="background:#f5f7fa;font-weight:600">
                                <td style="padding:10px;border:1px solid #ddd;text-align:right" colspan="3">Итого доходов:</td>
                                <td style="padding:10px;border:1px solid #ddd;text-align:right;color:#4caf50">${totalIncomes.toLocaleString()} ₽</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div style="background:#fff3cd;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #ffc107">
                        <div style="font-size:14px;color:#856404">
                            <strong>⚠️ Примечание:</strong> Для корректного заполнения КУДиР необходимо вести бухгалтерский учёт с использованием счетов 20, 26, 44 для учёта расходов.
                        </div>
                    </div>
                    
                    <div style="margin-top:20px;text-align:center">
                        <button onclick="closeModalYandex()" 
                                style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;

            showModalYandex(content);
        };
        
        // ============================================
        // ОТЧЁТ: ФОРМА №2 (ОТЧЁТ О ФИНАНСОВЫХ РЕЗУЛЬТАТАХ)
        // ============================================
        
        // Показать Форму №2
        window.showProfitLossReport = function() {
            const currentYear = new Date().getFullYear();
            
            // Получаем данные
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            
            // Фильтруем за текущий год
            const yearPayments = payments.filter(p => p.date.startsWith(currentYear));
            
            // Доходы
            const incomes = yearPayments.filter(p => ['entrance', 'share', 'membership'].includes(p.type));
            const totalIncomes = incomes.reduce((sum, p) => sum + p.amount, 0);
            
            // Расходы (условно считаем по проводкам)
            const expenseAccounts = ['20', '26', '44', '91'];
            const yearTransactions = transactions.filter(t => t.date.startsWith(currentYear));
            const expenses = yearTransactions.filter(t => expenseAccounts.includes(t.creditAccount));
            const totalExpenses = expenses.reduce((sum, t) => sum + t.amount, 0);
            
            // Финансовые результаты
            const grossProfit = totalIncomes - totalExpenses;
            const netProfit = grossProfit; // Упрощённо (без налогов)
            
            const content = `
                <div style="padding:30px;max-width:800px;margin:0 auto">
                    <h2 style="margin-bottom:10px;font-size:20px;font-weight:600;text-align:center">📈 Отчёт о финансовых результатах</h2>
                    <p style="text-align:center;color:#999;margin-bottom:20px">Форма №2 (ОКУД 0710002) за ${currentYear} год</p>
                    
                    <table style="width:100%;border-collapse:collapse;font-size:13px">
                        <thead>
                            <tr style="background:#f5f7fa">
                                <th style="padding:12px;border:1px solid #ddd;text-align:left" width="60%">Показатель</th>
                                <th style="padding:12px;border:1px solid #ddd;text-align:right" width="20%">За ${currentYear} год</th>
                                <th style="padding:12px;border:1px solid #ddd;text-align:right" width="20%">Код</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background:#e3f2fd;font-weight:600">
                                <td style="padding:12px;border:1px solid #ddd">Доходы от участия в кооперативе</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right;color:#4caf50">${totalIncomes.toLocaleString()} ₽</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">2110</td>
                            </tr>
                            <tr>
                                <td style="padding:12px;border:1px solid #ddd;padding-left:24px">Вступительные взносы</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">${incomes.filter(p => p.type === 'entrance').reduce((sum, p) => sum + p.amount, 0).toLocaleString()} ₽</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">—</td>
                            </tr>
                            <tr>
                                <td style="padding:12px;border:1px solid #ddd;padding-left:24px">Паевые взносы</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">${incomes.filter(p => p.type === 'share').reduce((sum, p) => sum + p.amount, 0).toLocaleString()} ₽</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">—</td>
                            </tr>
                            <tr>
                                <td style="padding:12px;border:1px solid #ddd;padding-left:24px">Членские взносы</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">${incomes.filter(p => p.type === 'membership').reduce((sum, p) => sum + p.amount, 0).toLocaleString()} ₽</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">—</td>
                            </tr>
                            
                            <tr style="background:#ffebee;font-weight:600">
                                <td style="padding:12px;border:1px solid #ddd">Расходы по обычной деятельности</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right;color:#f44336">${totalExpenses.toLocaleString()} ₽</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">2120</td>
                            </tr>
                            
                            <tr style="background:#f5f7fa;font-weight:600">
                                <td style="padding:12px;border:1px solid #ddd">Валовая прибыль (убыток)</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right;color:${grossProfit >= 0 ? '#4caf50' : '#f44336'}">${grossProfit >= 0 ? '+' : ''}${grossProfit.toLocaleString()} ₽</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">2100</td>
                            </tr>
                            
                            <tr>
                                <td style="padding:12px;border:1px solid #ddd">Прочие доходы</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">0 ₽</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">2340</td>
                            </tr>
                            <tr>
                                <td style="padding:12px;border:1px solid #ddd">Прочие расходы</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">0 ₽</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">2350</td>
                            </tr>
                            
                            <tr style="background:#e3f2fd;font-weight:700;font-size:14px">
                                <td style="padding:12px;border:1px solid #ddd">Чистая прибыль (убыток)</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right;color:${netProfit >= 0 ? '#0088cc' : '#f44336'}">${netProfit >= 0 ? '+' : ''}${netProfit.toLocaleString()} ₽</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">2400</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="margin-top:20px;padding:15px;background:#fff3cd;border-radius:8px;border-left:4px solid #ffc107">
                        <div style="font-size:13px;color:#856404">
                            <strong>⚠️ Примечание:</strong> Отчёт сформирован на основе данных кооператива. Для сдачи в налоговую необходимо заполнить официальную форму в бухгалтерской программе.
                        </div>
                    </div>
                    
                    <div style="margin-top:20px;text-align:center">
                        <button onclick="closeModalYandex()" 
                                style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;

            showModalYandex(content);
        };
        
        // ============================================
        // РСВ (РАСЧЁТ ПО СТРАХОВЫМ ВЗНОСАМ)
        // ============================================

        window.showRSVReport = function() {
            const currentYear = new Date().getFullYear();
            const currentQuarter = Math.floor(new Date().getMonth() / 3) + 1;

            // Получаем реальные данные
            const members = JSON.parse(localStorage.getItem('members') || '[]');
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');

            // Считаем реальные показатели
            const rsvData = {
                employees: members.length,  // Реальное количество пайщиков
                totalIncome: payments.reduce((sum, p) => sum + p.amount, 0),  // Реальная сумма доходов
                pensionInsurance: 0,
                medicalInsurance: 0,
                socialInsurance: 0
            };

            // Рассчитываем страховые взносы (30% от доходов)
            rsvData.pensionInsurance = Math.round(rsvData.totalIncome * 0.22);  // 22% ОПС
            rsvData.medicalInsurance = Math.round(rsvData.totalIncome * 0.051);  // 5.1% ОМС
            rsvData.socialInsurance = Math.round(rsvData.totalIncome * 0.029);  // 2.9% ВНиМ

            const totalInsurance = rsvData.pensionInsurance + rsvData.medicalInsurance + rsvData.socialInsurance;

            const content = `
                <div style="padding:30px;max-width:800px;margin:0 auto">
                    <h2 style="margin-bottom:10px;font-size:20px;font-weight:600;text-align:center">📊 РСВ</h2>
                    <p style="text-align:center;color:#999;margin-bottom:20px">Расчёт по страховым взносам за ${currentQuarter} квартал ${currentYear} года</p>

                    <div style="background:#f5f7fa;padding:15px;border-radius:8px;margin-bottom:20px">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                            <div>
                                <div style="font-size:13px;color:#666">Застрахованных лиц</div>
                                <div style="font-size:24px;font-weight:700;color:#0088cc">${rsvData.employees} чел.</div>
                            </div>
                            <div>
                                <div style="font-size:13px;color:#666">Общая сумма доходов</div>
                                <div style="font-size:20px;font-weight:700;color:#4caf50">${rsvData.totalIncome.toLocaleString()} ₽</div>
                            </div>
                        </div>
                    </div>

                    <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:20px">
                        <thead>
                            <tr style="background:#f5f7fa">
                                <th style="padding:12px;border:1px solid #ddd;text-align:left">Вид взносов</th>
                                <th style="padding:12px;border:1px solid #ddd;text-align:right">База (₽)</th>
                                <th style="padding:12px;border:1px solid #ddd;text-align:center">Ставка</th>
                                <th style="padding:12px;border:1px solid #ddd;text-align:right">Сумма (₽)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding:12px;border:1px solid #ddd">Пенсионное страхование (ОПС)</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">${rsvData.totalIncome.toLocaleString()}</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:center">22%</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right;color:#4caf50">${rsvData.pensionInsurance.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="padding:12px;border:1px solid #ddd">Медицинское страхование (ОМС)</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">${rsvData.totalIncome.toLocaleString()}</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:center">5.1%</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right;color:#4caf50">${rsvData.medicalInsurance.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="padding:12px;border:1px solid #ddd">Социальное страхование (ВНиМ)</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">${rsvData.totalIncome.toLocaleString()}</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:center">2.9%</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right;color:#4caf50">${rsvData.socialInsurance.toLocaleString()}</td>
                            </tr>
                            <tr style="background:#f5f7fa;font-weight:600">
                                <td style="padding:12px;border:1px solid #ddd">ИТОГО:</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">${rsvData.totalIncome.toLocaleString()}</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:center">30%</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right;color:#0088cc">${totalInsurance.toLocaleString()} ₽</td>
                            </tr>
                        </tbody>
                    </table>

                    <div style="margin-top:20px;padding:15px;background:#fff3cd;border-radius:8px;border-left:4px solid #ffc107">
                        <div style="font-size:13px;color:#856404">
                            <strong>⚠️ Примечание:</strong> Для сдачи в ФНС необходимо заполнить официальную форму в бухгалтерской программе.
                        </div>
                    </div>

                    <div style="margin-top:20px;text-align:center">
                        <button onclick="closeModalYandex()"
                                style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;

            showModalYandex(content);
        };
        
        // ============================================
        // СЗВ-СТАЖ
        // ============================================

        window.showSZVSTAZHReport = function() {
            const currentYear = new Date().getFullYear();

            // Получаем реальные данные пайщиков
            const members = JSON.parse(localStorage.getItem('members') || '[]');

            // Формируем список застрахованных лиц
            const employees = members.map((m, index) => ({
                snils: m.snils || `${100 + index}-${200 + index}-${300 + index} ${index}`,  // Если нет СНИЛС, генерируем
                name: m.name,
                period: `${m.createdAt ? new Date(m.createdAt).toLocaleDateString() : '01.01.' + currentYear} - ${new Date().toLocaleDateString()}`,
                type: 'Пайщик'
            }));

            let rowsHTML = '';
            employees.forEach((emp, idx) => {
                rowsHTML += `
                    <tr style="border-bottom:1px solid #eee">
                        <td style="padding:10px;text-align:center">${idx + 1}</td>
                        <td style="padding:10px;text-align:center">${emp.snils}</td>
                        <td style="padding:10px">${emp.name}</td>
                        <td style="padding:10px;text-align:center">${emp.period}</td>
                        <td style="padding:10px;text-align:center">✓</td>
                    </tr>
                `;
            });

            const content = `
                <div style="padding:30px;max-width:900px;margin:0 auto">
                    <h2 style="margin-bottom:10px;font-size:20px;font-weight:600;text-align:center">📋 СЗВ-СТАЖ</h2>
                    <p style="text-align:center;color:#999;margin-bottom:20px">Сведения о страховом стаже за ${currentYear} год</p>

                    <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:20px">
                        <thead>
                            <tr style="background:#f5f7fa">
                                <th style="padding:12px;border:1px solid #ddd;text-align:center">№</th>
                                <th style="padding:12px;border:1px solid #ddd;text-align:center">СНИЛС</th>
                                <th style="padding:12px;border:1px solid #ddd;text-align:left">ФИО</th>
                                <th style="padding:12px;border:1px solid #ddd;text-align:center">Период работы</th>
                                <th style="padding:12px;border:1px solid #ddd;text-align:center">Отметка</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHTML}
                        </tbody>
                    </table>

                    <div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px">
                        <div style="font-size:14px;color:#1565c0">
                            <strong>ℹ️ Информация:</strong> Форма СЗВ-СТАЖ сдаётся в ПФР ежегодно до 1 марта следующего года.
                        </div>
                    </div>

                    <div style="margin-top:20px;text-align:center">
                        <button onclick="closeModalYandex()"
                                style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;

            showModalYandex(content);
        };

        // ============================================
        // 6-НДФЛ
        // ============================================

        window.show6NDFLReport = function() {
            const currentYear = new Date().getFullYear();
            const currentQuarter = Math.floor(new Date().getMonth() / 3) + 1;

            // Получаем реальные данные
            const members = JSON.parse(localStorage.getItem('members') || '[]');
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');

            // Считаем реальные показатели
            const totalIncome = payments.reduce((sum, p) => sum + p.amount, 0);
            const taxBase = totalIncome;  // Налоговая база = доход
            const taxRate = 13;  // Ставка НДФЛ
            const taxAmount = Math.round(totalIncome * 0.13);  // 13% НДФЛ

            const ndflData = {
                employees: members.length,  // Реальное количество пайщиков
                totalIncome: totalIncome,  // Реальная сумма доходов
                taxBase: taxBase,
                taxRate: taxRate,
                taxAmount: taxAmount
            };

            const content = `
                <div style="padding:30px;max-width:800px;margin:0 auto">
                    <h2 style="margin-bottom:10px;font-size:20px;font-weight:600;text-align:center">📊 6-НДФЛ</h2>
                    <p style="text-align:center;color:#999;margin-bottom:20px">Расчёт налога на доходы физических лиц за ${currentQuarter} квартал ${currentYear} года</p>

                    <div style="background:#f5f7fa;padding:15px;border-radius:8px;margin-bottom:20px">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                            <div>
                                <div style="font-size:13px;color:#666">Физических лиц</div>
                                <div style="font-size:24px;font-weight:700;color:#0088cc">${ndflData.employees} чел.</div>
                            </div>
                            <div>
                                <div style="font-size:13px;color:#666">Налоговая ставка</div>
                                <div style="font-size:24px;font-weight:700;color:#0088cc">${ndflData.taxRate}%</div>
                            </div>
                        </div>
                    </div>

                    <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:20px">
                        <thead>
                            <tr style="background:#f5f7fa">
                                <th style="padding:12px;border:1px solid #ddd;text-align:left">Показатель</th>
                                <th style="padding:12px;border:1px solid #ddd;text-align:right">Сумма (₽)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding:12px;border:1px solid #ddd">Общая сумма доходов</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right;color:#4caf50">${ndflData.totalIncome.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="padding:12px;border:1px solid #ddd">Налоговая база</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right">${ndflData.taxBase.toLocaleString()}</td>
                            </tr>
                            <tr style="background:#f5f7fa;font-weight:600">
                                <td style="padding:12px;border:1px solid #ddd">Исчисленная сумма налога</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right;color:#f44336">${ndflData.taxAmount.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="padding:12px;border:1px solid #ddd">Удержанная сумма налога</td>
                                <td style="padding:12px;border:1px solid #ddd;text-align:right;color:#f44336">${ndflData.taxAmount.toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div style="margin-top:20px;padding:15px;background:#fff3cd;border-radius:8px;border-left:4px solid #ffc107">
                        <div style="font-size:13px;color:#856404">
                            <strong>⚠️ Примечание:</strong> Для сдачи в ФНС необходимо заполнить официальную форму в бухгалтерской программе.
                        </div>
                    </div>

                    <div style="margin-top:20px;text-align:center">
                        <button onclick="closeModalYandex()"
                                style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;

            showModalYandex(content);
        };

        window.handleMenuAction = function(actionName) {
            console.log('⚙️ Действие меню:', actionName);

            // Обработка конкретных действий
            switch(actionName) {
                case 'create-member':
                    showCreateMemberModal();
                    break;

                case 'create-payment':
                    showCreatePaymentModal();
                    break;

                case 'create-transaction':
                    showCreateTransactionModal();
                    break;

                case 'pko':
                    showPKOModal();
                    break;

                case 'rko':
                    showRKOModal();
                    break;

                case 'act-sverka':
                    showActSverkaModal();
                    break;

                case 'generate-protocol':
                    showProtocolModal();
                    break;

                case 'generate-certificate':
                    showCertificateModal();
                    break;

                case 'generate-spravka':
                    showSpravkaModal();
                    break;

                default:
                    // Показываем уведомление для остальных действий
                    if (typeof window.showToast === 'function') {
                        window.showToast({
                            type: 'info',
                            message: 'Действие "' + actionName + '" в разработке',
                            duration: 3000
                        });
                    } else {
                        alert('Действие: ' + actionName + ' (в разработке)');
                    }
            }
        };

        // ============================================
        // БУХГАЛТЕРИЯ: СПРАВОЧНИК СЧЕТОВ
        // ============================================

        // План счетов для ПОТРЕБИТЕЛЬСКОГО КООПЕРАТИВА (3085-1)
        // Обновлён: 19 февраля 2026
        window.chartOfAccounts = [
            // === РАЗДЕЛ 1. ВНЕОБОРОТНЫЕ АКТИВЫ ===
            { code: '01', name: 'Основные средства', type: 'active' },
            { code: '02', name: 'Амортизация основных средств', type: 'passive' },
            { code: '04', name: 'Нематериальные активы', type: 'active' },
            { code: '05', name: 'Амортизация нематериальных активов', type: 'passive' },
            { code: '08', name: 'Вложения во внеоборотные активы', type: 'active' },
            
            // === РАЗДЕЛ 2. ЗАПАСЫ ===
            { code: '10', name: 'Материалы', type: 'active' },
            { code: '41', name: 'Товары', type: 'active' },
            { code: '43', name: 'Готовая продукция', type: 'active' },
            
            // === РАЗДЕЛ 3. ФИНАНСОВЫЕ ВЛОЖЕНИЯ ===
            { code: '58', name: 'Финансовые вложения', type: 'active', subaccounts: [
                '58.1 - Паи и акции',
                '58.2 - Долговые ценные бумаги',
                '58.3 - Предоставленные займы'
            ]},
            
            // === РАЗДЕЛ 4. ДЕНЕЖНЫЕ СРЕДСТВА ===
            { code: '50', name: 'Касса', type: 'active', subaccounts: [
                '50.1 - Касса организации',
                '50.2 - Операционная касса'
            ]},
            { code: '51', name: 'Расчётные счета', type: 'active' },
            { code: '52', name: 'Валютные счета', type: 'active' },
            { code: '55', name: 'Специальные счета в банках', type: 'active' },
            
            // === РАЗДЕЛ 5. РАСЧЁТЫ С ПАЙЩИКАМИ (КРИТИЧНО!) ===
            { code: '75', name: 'Расчёты с пайщиками', type: 'active-passive', subaccounts: [
                '75.1 - Расчёты по паевым взносам',
                '75.2 - Расчёты по вступительным взносам',
                '75.3 - Расчёты по членским взносам',
                '75.4 - Расчёты по дополнительным взносам',
                '75.5 - Расчёты по выплате стоимости пая',
                '75.6 - Расчёты по распределению доходов'
            ]},
            
            // === РАЗДЕЛ 6. РАСЧЁТЫ С ПЕРСОНАЛОМ ===
            { code: '70', name: 'Расчёты с персоналом по оплате труда', type: 'passive' },
            { code: '71', name: 'Расчёты с подотчётными лицами', type: 'active-passive' },
            { code: '73', name: 'Расчёты с персоналом по прочим операциям', type: 'active-passive' },
            
            // === РАЗДЕЛ 7. РАСЧЁТЫ С БЮДЖЕТОМ И ВНЕБЮДЖЕТНЫМИ ФОНДАМИ ===
            { code: '68', name: 'Расчёты по налогам и сборам', type: 'passive' },
            { code: '69', name: 'Расчёты по социальному страхованию', type: 'passive' },
            
            // === РАЗДЕЛ 8. РАСЧЁТЫ С КРЕДИТОРАМИ И ДЕБИТОРАМИ ===
            { code: '60', name: 'Расчёты с поставщиками и подрядчиками', type: 'active-passive' },
            { code: '62', name: 'Расчёты с покупателями и заказчиками', type: 'active-passive' },
            { code: '66', name: 'Расчёты по краткосрочным кредитам и займам', type: 'passive' },
            { code: '67', name: 'Расчёты по долгосрочным кредитам и займам', type: 'passive' },
            { code: '76', name: 'Расчёты с разными дебиторами и кредиторами', type: 'active-passive', subaccounts: [
                '76.1 - Имущественное страхование',
                '76.2 - Расчёты по претензиям',
                '76.3 - Расчёты по причитающимся процентам',
                '76.4 - Расчёты по депонированным суммам'
            ]},
            
            // === РАЗДЕЛ 9. КАПИТАЛ И РЕЗЕРВЫ ===
            { code: '80', name: 'Уставный капитал', type: 'passive' },
            { code: '82', name: 'Резервный капитал', type: 'passive', subaccounts: [
                '82.1 - Резервный фонд кооператива',
                '82.2 - Другие резервы'
            ]},
            { code: '83', name: 'Добавочный капитал', type: 'passive' },
            { code: '84', name: 'Нераспределённая прибыль (непокрытый убыток)', type: 'passive' },
            
            // === РАЗДЕЛ 10. ЦЕЛЕВОЕ ФИНАНСИРОВАНИЕ (КРИТИЧНО!) ===
            { code: '86', name: 'Целевое финансирование (взносы пайщиков)', type: 'passive', subaccounts: [
                '86.1 - Вступительные взносы',
                '86.2 - Паевые взносы',
                '86.3 - Членские взносы',
                '86.4 - Дополнительные взносы',
                '86.5 - Имущественные взносы',
                '86.6 - Добровольные взносы'
            ]},
            
            // === РАЗДЕЛ 11. ДОХОДЫ И РАСХОДЫ ===
            { code: '90', name: 'Продажи', type: 'active-passive', subaccounts: [
                '90.1 - Выручка',
                '90.2 - Себестоимость продаж',
                '90.9 - Прибыль/убыток от продаж'
            ]},
            { code: '91', name: 'Прочие доходы и расходы', type: 'active-passive', subaccounts: [
                '91.1 - Прочие доходы',
                '91.2 - Прочие расходы',
                '91.9 - Сальдо прочих доходов и расходов'
            ]},
            { code: '98', name: 'Доходы будущих периодов', type: 'passive' },
            { code: '99', name: 'Прибыли и убытки', type: 'passive', subaccounts: [
                '99.1 - Прибыль/убыток до налогообложения',
                '99.2 - Налог на прибыль',
                '99.9 - Чистая прибыль/убыток'
            ]}
        ];

        // ============================================
        // ТИПОВЫЕ ПРОВОДКИ ДЛЯ ПОТРЕБИТЕЛЬСКОГО КООПЕРАТИВА (3085-1)
        // ============================================

        window.standardTransactions = [
            // ВСТУПИТЕЛЬНЫЕ ВЗНОСЫ
            { name: 'Внесение вступительного взноса наличными', debit: '50.1', credit: '86.1', description: 'Внесение вступительного взноса пайщиком' },
            { name: 'Внесение вступительного взноса на р/с', debit: '51', credit: '86.1', description: 'Внесение вступительного взноса на р/с' },
            
            // ПАЕВЫЕ ВЗНОСЫ
            { name: 'Внесение паевого взноса наличными', debit: '50.1', credit: '86.2', description: 'Внесение паевого взноса пайщиком' },
            { name: 'Внесение паевого взноса на р/с', debit: '51', credit: '86.2', description: 'Внесение паевого взноса на р/с' },
            { name: 'Возврат паевого взноса', debit: '75.5', credit: '50.1', description: 'Выплата стоимости пая при выходе' },
            
            // ЧЛЕНСКИЕ ВЗНОСЫ
            { name: 'Внесение членского взноса наличными', debit: '50.1', credit: '86.3', description: 'Внесение членского взноса' },
            { name: 'Внесение членского взноса на р/с', debit: '51', credit: '86.3', description: 'Внесение членского взноса на р/с' },
            
            // ДОПОЛНИТЕЛЬНЫЕ ВЗНОСЫ
            { name: 'Внесение дополнительного взноса', debit: '50.1', credit: '86.4', description: 'Внесение дополнительного взноса' },
            
            // ИМУЩЕСТВЕНН��Е ВЗНОСЫ
            { name: 'Внесение имущественного взноса', debit: '08', credit: '86.5', description: 'Внесен��е имущества в кооператив' },
            { name: 'Принятие ОС к учёту', debit: '01', credit: '08', description: 'Принятие основного средства к учёту' },
            
            // ВЫПЛАТА ДОХОДОВ
            { name: 'Начисление доходов пайщику', debit: '91.2', credit: '75.6', description: 'Начисление доходов от участия' },
            { name: 'Выплата доходов пайщику', debit: '75.6', credit: '50.1', description: 'Выплата доходов пайщику из кассы' },
            
            // ХОЗЯЙСТВЕННЫЕ ОПЕРАЦИИ
            { name: 'Поступление товаров', debit: '41', credit: '60', description: 'Поступление товаров от поставщика' },
            { name: 'Оплата поставщику', debit: '60', credit: '51', description: 'Оплата поставщику с р/с' },
            { name: 'Выдача денег под отчёт', debit: '71', credit: '50.1', description: 'Выдача денег под отчёт' },
            { name: 'Начисление зарплаты', debit: '91.2', credit: '70', description: 'Начисление заработной платы' },
            { name: 'Выплата зарплаты', debit: '70', credit: '50.1', description: 'Выплата заработной платы' },
            
            // НАЛОГИ
            { name: 'Начисление налога УСН', debit: '99', credit: '68', description: 'Начисление налога по УСН' },
            { name: 'Уплата налога УСН', debit: '68', credit: '51', description: 'Уплата налога УСН' },
            
            // ФИНАНСОВЫЕ ВЛОЖЕНИЯ
            { name: 'Предоставление займа пайщику', debit: '58.3', credit: '51', description: 'Предоставление займа пайщику' },
            { name: 'Возврат займа от пайщика', debit: '51', credit: '58.3', description: 'Возврат займа от пайщика' },
            { name: 'Начисление процентов по займу', debit: '76.3', credit: '91.1', description: 'Начисление процентов по займу' }
        ];

        // ============================================
        // БУХГАЛТЕРИЯ: ПРОВОДКИ
        // ============================================

        // Создать проводку
        window.showCreateTransactionModal = function() {
            const accounts = window.chartOfAccounts;

            let accountOptions = '<option value="">Выберите счёт</option>';
            accounts.forEach(acc => {
                accountOptions += `<option value="${acc.code}">${acc.code} - ${acc.name}</option>`;
            });

            const content = `
                <div style="padding:30px;max-width:600px;margin:0 auto">
                    <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">📒 Создать проводку</h2>

                    <form id="createTransactionForm" onsubmit="return handleCreateTransaction(event)">
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Счёт Дт *</label>
                            <select name="debitAccount" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                ${accountOptions}
                            </select>
                        </div>

                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Счёт Кт *</label>
                            <select name="creditAccount" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                ${accountOptions}
                            </select>
                        </div>

                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Сумма (₽) *</label>
                            <input type="number" name="amount" required min="0.01" step="0.01"
                                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"
                                   placeholder="1000.00">
                        </div>

                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Дата</label>
                            <input type="date" name="date"
                                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>

                        <div style="margin-bottom:20px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Содержание операции</label>
                            <textarea name="description" rows="3" required
                                      style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"
                                      placeholder="Например: Внесение пая Ивановым И.И."></textarea>
                        </div>

                        <div style="display:flex;gap:10px;justify-content:flex-end">
                            <button type="button" onclick="closeModalYandex()"
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Отмена
                            </button>
                            <button type="submit"
                                    style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                📒 Провести
                            </button>
                        </div>
                    </form>
                </div>
            `;

            showModalYandex(content);
        };

        // Обработка создания проводки
        window.handleCreateTransaction = function(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);

            const transaction = {
                debitAccount: formData.get('debitAccount'),
                creditAccount: formData.get('creditAccount'),
                amount: parseFloat(formData.get('amount')),
                date: formData.get('date') || new Date().toISOString().split('T')[0],
                description: formData.get('description')
            };

            // Проверка: Дт != Кт
            if (transaction.debitAccount === transaction.creditAccount) {
                alert('Счета Дт и Кт должны быть разными!');
                return false;
            }

            console.log('📒 Новая проводка:', transaction);

            // Сохраняем в localStorage
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            transaction.id = Date.now();
            transaction.createdAt = new Date().toISOString();
            transactions.push(transaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));

            console.log('✅ Проводка сохранена. Всего проводок:', transactions.length);

            // Закрываем модальное окно
            closeModalYandex();

            // Показываем уведомление
            if (typeof window.showToast === 'function') {
                window.showToast({
                    type: 'success',
                    message: `✅ Проводка Д${transaction.debitAccount} К${transaction.creditAccount} на сумму ${transaction.amount}₽ проведена!`,
                    duration: 3000
                });
            }

            // Тактильный отклик
            if (window.TelegramMiniApp) {
                window.TelegramMiniApp.hapticFeedback('success');
            }

            return false;
        };
        
        // ============================================
        // ПКО (ПРИХОДНЫЙ КАССОВЫЙ ОРДЕР)
        // ============================================

        window.showPKOModal = function() {
            const members = JSON.parse(localStorage.getItem('members') || '[]');

            let memberOptions = '<option value="">Выберите пайщика</option>';
            members.forEach(member => {
                memberOptions += `<option value="${member.id}">${member.name}</option>`;
            });

            const content = `
                <div style="padding:30px;max-width:700px;margin:0 auto">
                    <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">📄 ПКО (Приходный кассовый ордер)</h2>

                    <form id="pkoForm" onsubmit="return generatePKO(event)">
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Номер ПКО *</label>
                            <input type="text" name="number" required placeholder="№ 1" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>

                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Дата *</label>
                            <input type="date" name="date" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>

                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Пайщик *</label>
                            <select name="memberId" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                ${memberOptions}
                            </select>
                        </div>

                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Сумма (₽) *</label>
                            <input type="number" name="amount" required min="1" step="0.01" placeholder="1000.00" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>

                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Основание *</label>
                            <select name="reason" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                <option value="entrance">Вступительный взнос</option>
                                <option value="share">Паевой взнос</option>
                                <option value="membership">Членский взнос</option>
                                <option value="additional">Дополнительный взнос</option>
                                <option value="repayment">Погашение займа</option>
                                <option value="other">Прочее</option>
                            </select>
                        </div>

                        <div style="margin-bottom:20px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">От кого *</label>
                            <input type="text" name="from" required placeholder="ФИО полностью" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>

                        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                            <button type="button" onclick="closeModalYandex()"
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Отмена
                            </button>
                            <button type="submit"
                                    style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                📄 Сформировать
                            </button>
                        </div>
                    </form>
                </div>
            `;

            showModalYandex(content);
        };

        window.generatePKO = function(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);

            const number = formData.get('number');
            const date = formData.get('date');
            const memberId = formData.get('memberId');
            const amount = parseFloat(formData.get('amount'));
            const reason = formData.get('reason');
            const from = formData.get('from');

            const members = JSON.parse(localStorage.getItem('members') || '[]');
            const member = members.find(m => m.id == memberId);

            if (!member) {
                alert('Пайщик не найден!');
                return false;
            }

            const reasonTexts = {
                entrance: 'Вступительный взнос',
                share: 'Паевой взнос',
                membership: 'Членский взнос',
                additional: 'Дополнительный взнос',
                repayment: 'Погашение займа',
                other: 'Прочее'
            };

            const amountInWords = amountToWords(amount);

            const content = `
                <div style="padding:30px;max-width:700px;margin:0 auto">
                    <h2 style="text-align:center;font-size:16px;font-weight:600;margin-bottom:10px">ПРИХОДНЫЙ КАССОВЫЙ ОРДЕР</h2>
                    <p style="text-align:center;color:#666;margin-bottom:20px">Форма № КО-1</p>

                    <div style="display:flex;justify-content:space-between;margin-bottom:20px">
                        <div>
                            <p><strong>Организация:</strong> КПК</p>
                        </div>
                        <div style="text-align:right">
                            <p><strong>Номер:</strong> ${number}</p>
                            <p><strong>Дата:</strong> ${new Date(date).toLocaleDateString('ru')}</p>
                        </div>
                    </div>

                    <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:20px">
                        <tr>
                            <td style="padding:8px;border:1px solid #ddd;width:30%"><strong>Код по ОКПО</strong></td>
                            <td style="padding:8px;border:1px solid #ddd;width:70%">__________</td>
                        </tr>
                        <tr>
                            <td style="padding:8px;border:1px solid #ddd"><strong>Вид деятельности</strong></td>
                            <td style="padding:8px;border:1px solid #ddd">__________</td>
                        </tr>
                    </table>

                    <div style="background:#f5f7fa;padding:15px;border-radius:8px;margin-bottom:20px">
                        <p style="margin-bottom:10px"><strong>Принято от:</strong> ${from}</p>
                        <p style="margin-bottom:10px"><strong>Основание:</strong> ${reasonTexts[reason]}</p>
                        <p style="margin-bottom:10px"><strong>Сумма:</strong> ${amount.toLocaleString()} ₽</p>
                        <p style="margin-bottom:0"><strong>Сумма прописью:</strong> ${amountInWords}</p>
                    </div>

                    <div style="margin-top:40px;display:grid;grid-template-columns:1fr 1fr;gap:40px">
                        <div style="text-align:center">
                            <p style="border-top:1px solid #000;padding-top:5px;margin-top:40px">Главный бухгалтер</p>
                        </div>
                        <div style="text-align:center">
                            <p style="border-top:1px solid #000;padding-top:5px;margin-top:40px">Кассир</p>
                        </div>
                    </div>

                    <div style="margin-top:20px;text-align:center">
                        <button onclick="window.print()"
                                style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;margin-right:10px">
                            🖨️ Печать
                        </button>
                        <button onclick="closeModalYandex()"
                                style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;

            showModalYandex(content);
            return false;
        };

        // Функция перевода суммы в слова
        function amountToWords(amount) {
            const rubles = Math.floor(amount);
            const kopecks = Math.round((amount - rubles) * 100);

            // Упрощённая версия (для демонстрации)
            return `${rubles} рублей ${kopecks} копеек`;
        };

        // ============================================
        // РКО (РАСХОДНЫЙ КАССОВЫЙ ОРДЕР)
        // ============================================

        window.showRKOModal = function() {
            const members = JSON.parse(localStorage.getItem('members') || '[]');

            let memberOptions = '<option value="">Выберите пайщика</option>';
            members.forEach(member => {
                memberOptions += `<option value="${member.id}">${member.name}</option>`;
            });

            const content = `
                <div style="padding:30px;max-width:700px;margin:0 auto">
                    <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">📄 РКО (Расходный кассовый ордер)</h2>

                    <form id="rkoForm" onsubmit="return generateRKO(event)">
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Номер РКО *</label>
                            <input type="text" name="number" required placeholder="№ 1" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>

                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Дата *</label>
                            <input type="date" name="date" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>

                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Пайщик *</label>
                            <select name="memberId" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                ${memberOptions}
                            </select>
                        </div>

                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Сумма (₽) *</label>
                            <input type="number" name="amount" required min="1" step="0.01" placeholder="1000.00" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>

                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Основание *</label>
                            <select name="reason" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                <option value="dividends">Выплата дивидендов</option>
                                <option value="repayment">Возврат пая</option>
                                <option value="salary">Выплата зарплаты</option>
                                <option value="expenses">Хозяйственные расходы</option>
                                <option value="other">Прочее</option>
                            </select>
                        </div>

                        <div style="margin-bottom:20px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Кому *</label>
                            <input type="text" name="to" required placeholder="ФИО полностью" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>

                        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                            <button type="button" onclick="closeModalYandex()"
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Отмена
                            </button>
                            <button type="submit"
                                    style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                📄 Сформировать
                            </button>
                        </div>
                    </form>
                </div>
            `;

            showModalYandex(content);
        };

        window.generateRKO = function(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);

            const number = formData.get('number');
            const date = formData.get('date');
            const memberId = formData.get('memberId');
            const amount = parseFloat(formData.get('amount'));
            const reason = formData.get('reason');
            const to = formData.get('to');

            const members = JSON.parse(localStorage.getItem('members') || '[]');
            const member = members.find(m => m.id == memberId);

            if (!member) {
                alert('Пайщик не найден!');
                return false;
            }

            const reasonTexts = {
                dividends: 'Выплата дивидендов',
                repayment: 'Возврат пая',
                salary: 'Выплата зарплаты',
                expenses: 'Хозяйственные расходы',
                other: 'Прочее'
            };

            const amountInWords = amountToWords(amount);

            const content = `
                <div style="padding:30px;max-width:700px;margin:0 auto">
                    <h2 style="text-align:center;font-size:16px;font-weight:600;margin-bottom:10px">РАСХОДНЫЙ КАССОВЫЙ ОРДЕР</h2>
                    <p style="text-align:center;color:#666;margin-bottom:20px">Форма № КО-2</p>

                    <div style="display:flex;justify-content:space-between;margin-bottom:20px">
                        <div>
                            <p><strong>Организация:</strong> КПК</p>
                        </div>
                        <div style="text-align:right">
                            <p><strong>Номер:</strong> ${number}</p>
                            <p><strong>Дата:</strong> ${new Date(date).toLocaleDateString('ru')}</p>
                        </div>
                    </div>

                    <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:20px">
                        <tr>
                            <td style="padding:8px;border:1px solid #ddd;width:30%"><strong>Код по ОКПО</strong></td>
                            <td style="padding:8px;border:1px solid #ddd;width:70%">__________</td>
                        </tr>
                        <tr>
                            <td style="padding:8px;border:1px solid #ddd"><strong>Вид деятельности</strong></td>
                            <td style="padding:8px;border:1px solid #ddd">__________</td>
                        </tr>
                    </table>

                    <div style="background:#f5f7fa;padding:15px;border-radius:8px;margin-bottom:20px">
                        <p style="margin-bottom:10px"><strong>Выдать:</strong> ${to}</p>
                        <p style="margin-bottom:10px"><strong>Основание:</strong> ${reasonTexts[reason]}</p>
                        <p style="margin-bottom:10px"><strong>Сумма:</strong> ${amount.toLocaleString()} ₽</p>
                        <p style="margin-bottom:0"><strong>Сумма прописью:</strong> ${amountInWords}</p>
                    </div>

                    <div style="margin-top:40px;display:grid;grid-template-columns:1fr 1fr;gap:40px">
                        <div style="text-align:center">
                            <p style="border-top:1px solid #000;padding-top:5px;margin-top:40px">Главный бухгалтер</p>
                        </div>
                        <div style="text-align:center">
                            <p style="border-top:1px solid #000;padding-top:5px;margin-top:40px">Кассир</p>
                        </div>
                    </div>

                    <div style="margin-top:20px;text-align:center">
                        <button onclick="window.print()"
                                style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;margin-right:10px">
                            🖨️ Печать
                        </button>
                        <button onclick="closeModalYandex()"
                                style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;

            showModalYandex(content);
            return false;
        };
        
        // ============================================
        // ФОРМА: ДОБАВИТЬ ПАЙЩИКА
        // ============================================
        
        // Показать форму добавления пайщика
        window.showCreateMemberModal = function() {
            const content = `
                <div style="padding:30px;max-width:600px;margin:0 auto">
                    <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">➕ Добавить пайщика</h2>
                    
                    <form id="createMemberForm" onsubmit="return handleCreateMember(event)">
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">ФИО *</label>
                            <input type="text" name="name" required 
                                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"
                                   placeholder="Иванов Иван Иванович">
                        </div>
                        
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Телефон</label>
                            <input type="tel" name="phone" 
                                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"
                                   placeholder="+7 (999) 123-45-67">
                        </div>
                        
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Email</label>
                            <input type="email" name="email" 
                                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"
                                   placeholder="ivanov@example.com">
                        </div>
                        
                        <div style="margin-bottom:20px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Вступительный взнос (₽)</label>
                            <input type="number" name="entranceFee" min="0" 
                                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"
                                   placeholder="5000">
                        </div>
                        
                        <div style="display:flex;gap:10px;justify-content:flex-end">
                            <button type="button" onclick="closeModalYandex()" 
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Отмена
                            </button>
                            <button type="submit" 
                                    style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                ➕ Добавить
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModalYandex(content);
        };
        
        // Обработка отправки формы
        window.handleCreateMember = function(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const newMember = {
                name: formData.get('name'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                entranceFee: parseFloat(formData.get('entranceFee')) || 0
            };
            
            console.log('📝 Новый пайщик:', newMember);
            
            // Сохраняем в localStorage
            const members = JSON.parse(localStorage.getItem('members') || '[]');
            newMember.id = Date.now();  // Генерируем уникальный ID
            newMember.createdAt = new Date().toISOString();
            members.push(newMember);
            localStorage.setItem('members', JSON.stringify(members));
            
            console.log('✅ Пайщик сохранён. Всего пайщиков:', members.length);
            
            // Закрываем модальное окно
            closeModalYandex();
            
            // Показываем уведомление
            if (typeof window.showToast === 'function') {
                window.showToast({
                    type: 'success',
                    message: `✅ Пайщик "${newMember.name}" добавлен!`,
                    duration: 3000
                });
            } else {
                alert(`✅ Пайщик "${newMember.name}" добавлен!`);
            }
            
            // Тактильный отклик
            if (window.TelegramMiniApp) {
                window.TelegramMiniApp.hapticFeedback('success');
            }
            
            // Обновляем список чатов в messenger
            if (typeof window.renderChats === 'function') {
                window.renderChats();
            }
            
            return false;
        };
        
        // ============================================
        // ФОРМА: ДОБАВИТЬ ВЗНОС
        // ============================================
        
        // Показать форму добавления взноса
        window.showCreatePaymentModal = function() {
            const content = `
                <div style="padding:30px;max-width:600px;margin:0 auto">
                    <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">💳 Добавить взнос</h2>
                    
                    <form id="createPaymentForm" onsubmit="return handleCreatePayment(event)">
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Пайщик *</label>
                            <select name="memberId" required 
                                    style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                <option value="">Выберите пайщика</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Тип взноса *</label>
                            <select name="type" required 
                                    style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                <option value="">Выберите тип</option>
                                <option value="entrance">Вступительный</option>
                                <option value="membership">Членский</option>
                                <option value="share">Паевой</option>
                                <option value="additional">Дополнительный</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Сумма (₽) *</label>
                            <input type="number" name="amount" required min="1" step="0.01"
                                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"
                                   placeholder="5000">
                        </div>
                        
                        <div style="margin-bottom:15px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Дата</label>
                            <input type="date" name="date" 
                                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                        </div>
                        
                        <div style="margin-bottom:20px">
                            <label style="display:block;margin-bottom:5px;font-weight:500">Назначение</label>
                            <textarea name="description" rows="3"
                                      style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"
                                      placeholder="Например: Вступительный взнос"></textarea>
                        </div>
                        
                        <div style="display:flex;gap:10px;justify-content:flex-end">
                            <button type="button" onclick="closeModalYandex()" 
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Отмена
                            </button>
                            <button type="submit" 
                                    style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                💳 Внести
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModalYandex(content);
            
            // Заполняем список пайщиков
            setTimeout(() => {
                const select = document.querySelector('select[name="memberId"]');
                if (select) {
                    const members = JSON.parse(localStorage.getItem('members') || '[]');
                    members.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = member.name;
                        select.appendChild(option);
                    });
                }
            }, 100);
        };
        
        // Обработка отправки формы взноса
        window.handleCreatePayment = function(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const newPayment = {
                memberId: formData.get('memberId'),
                type: formData.get('type'),
                amount: parseFloat(formData.get('amount')),
                date: formData.get('date') || new Date().toISOString().split('T')[0],
                description: formData.get('description'),
                status: 'paid'
            };
            
            // Находим имя пайщика
            const members = JSON.parse(localStorage.getItem('members') || '[]');
            const member = members.find(m => m.id == newPayment.memberId);
            newPayment.memberName = member ? member.name : 'Неизвестно';
            
            console.log('💳 Новый взнос:', newPayment);
            
            // Сохраняем в localStorage
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');
            newPayment.id = Date.now();
            newPayment.createdAt = new Date().toISOString();
            payments.push(newPayment);
            localStorage.setItem('payments', JSON.stringify(payments));
            
            console.log('✅ Взнос сохранён. Всего взносов:', payments.length);
            
            // Закрываем модальное окно
            closeModalYandex();
            
            // Показываем уведомление
            if (typeof window.showToast === 'function') {
                window.showToast({
                    type: 'success',
                    message: `✅ Взнос "${newPayment.memberName}" на сумму ${newPayment.amount}₽ внесён!`,
                    duration: 3000
                });
            } else {
                alert(`✅ Взнос "${newPayment.memberName}" на сумму ${newPayment.amount}₽ внесён!`);
            }
            
            // Тактильный отклик
            if (window.TelegramMiniApp) {
                window.TelegramMiniApp.hapticFeedback('success');
            }
            
            return false;
        };

        // Обновляем обработчики кнопок для использования PanelManager
        document.addEventListener('DOMContentLoaded', () => {
            // Кнопка закрытия левого меню
            const menuCloseBtn = document.getElementById('menuCloseBtn');
            if (menuCloseBtn) {
                menuCloseBtn.addEventListener('click', () => {
                    PanelManager.close('sidebarMenu');
                });
            }

            // Бургер меню
            const burgerBtn = document.getElementById('burgerBtn');
            if (burgerBtn) {
                burgerBtn.addEventListener('click', () => {
                    PanelManager.open('sidebarMenu');
                });
            }

            // ============================================
            // ВОЗВРАТ ВЗНОСА
            // ============================================

            window.showReturnPaymentModal = function() {
                const members = JSON.parse(localStorage.getItem('members') || '[]');
                const payments = JSON.parse(localStorage.getItem('payments') || '[]');

                if (members.length === 0) {
                    alert('❌ Нет пайщиков в базе!');
                    return;
                }

                let memberOptions = '<option value="">Выберите пайщика</option>';
                members.forEach(member => {
                    const memberPayments = payments.filter(p => p.memberId == member.id);
                    const totalPaid = memberPayments.reduce((sum, p) => sum + p.amount, 0);
                    memberOptions += `<option value="${member.id}">${member.name} (внесено: ${totalPaid.toLocaleString()}₽)</option>`;
                });

                const content = `
                    <div style="padding:30px;max-width:700px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">↩️ Возврат взноса</h2>

                        <form id="returnPaymentForm" onsubmit="return handleReturnPayment(event)">
                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Пайщик *</label>
                                <select name="memberId" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                    ${memberOptions}
                                </select>
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Сумма возврата (₽) *</label>
                                <input type="number" name="amount" required min="1" step="0.01" placeholder="1000.00" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Основание *</label>
                                <select name="reason" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                    <option value="exit">Выход из кооператива</option>
                                    <option value="death">Смерть пайщика</option>
                                    <option value="exclusion">Исключение из кооператива</option>
                                    <option value="other">Другое</option>
                                </select>
                            </div>

                            <div style="margin-bottom:20px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Комментарий</label>
                                <textarea name="comment" rows="3" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"></textarea>
                            </div>

                            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                                <button type="button" onclick="closeModalYandex()"
                                        style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                    Отмена
                                </button>
                                <button type="submit"
                                        style="padding:12px 24px;background:#f44336;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                    ↩️ Вернуть
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                showModalYandex(content);
            };

            window.handleReturnPayment = function(event) {
                event.preventDefault();

                const form = event.target;
                const formData = new FormData(form);

                const memberId = formData.get('memberId');
                const amount = parseFloat(formData.get('amount'));
                const reason = formData.get('reason');
                const comment = formData.get('comment');

                const members = JSON.parse(localStorage.getItem('members') || '[]');
                const member = members.find(m => m.id == memberId);

                if (!member) {
                    alert('Пайщик не найден!');
                    return false;
                }

                // Создаём проводку на возврат (Дт 75.5 Кт 50.1)
                const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                transactions.push({
                    id: Date.now(),
                    debitAccount: '75.5',  // Расчёты по выплате стоимости пая
                    creditAccount: '50.1',  // Касса
                    amount: amount,
                    date: new Date().toISOString().split('T')[0],
                    description: `Возврат взноса: ${reason}. ${comment}`,
                    memberId: memberId
                });
                localStorage.setItem('transactions', JSON.stringify(transactions));

                // Закрываем модальное окно
                closeModalYandex();

                // Показываем уведомление
                if (typeof window.showToast === 'function') {
                    window.showToast({
                        type: 'success',
                        message: `✅ Взнос возвращён ${member.name}: ${amount.toLocaleString()}₽`,
                        duration: 3000
                    });
                }

                // Тактильный отклик
                if (window.TelegramMiniApp) {
                    window.TelegramMiniApp.hapticFeedback('success');
                }

                return false;
            };

            // ============================================
            // ПОДАТЬ ЗАЯВЛЕНИЕ
            // ============================================

            window.showSubmitApplicationModal = function() {
                const content = `
                    <div style="padding:30px;max-width:700px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">📝 Подать заявление</h2>

                        <form id="submitApplicationForm" onsubmit="return handleSubmitApplication(event)">
                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Тип заявления *</label>
                                <select name="type" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                    <option value="join">О вступлении в кооператив</option>
                                    <option value="exit">О выходе из кооператива</option>
                                    <option value="transfer">О переходе паевого взноса</option>
                                    <option value="payment">Об отсрочке платежа</option>
                                    <option value="other">Другое</option>
                                </select>
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">ФИО заявителя *</label>
                                <input type="text" name="fullName" required placeholder="Иванов Иван Иванович" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Телефон *</label>
                                <input type="tel" name="phone" required placeholder="+7 (999) 123-45-67" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:20px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Текст заявления *</label>
                                <textarea name="text" rows="5" required placeholder="Прошу принять меня в члены потребительского кооператива..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"></textarea>
                            </div>

                            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                                <button type="button" onclick="closeModalYandex()"
                                        style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                    Отмена
                                </button>
                                <button type="submit"
                                        style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                    📝 Подать
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                showModalYandex(content);
            };

            window.handleSubmitApplication = function(event) {
                event.preventDefault();

                const form = event.target;
                const formData = new FormData(form);

                const application = {
                    id: Date.now(),
                    type: formData.get('type'),
                    fullName: formData.get('fullName'),
                    phone: formData.get('phone'),
                    text: formData.get('text'),
                    status: 'pending',  // pending, approved, rejected
                    createdAt: new Date().toISOString()
                };

                // Сохраняем в localStorage
                const applications = JSON.parse(localStorage.getItem('applications') || '[]');
                applications.push(application);
                localStorage.setItem('applications', JSON.stringify(applications));

                // Закрываем модальное окно
                closeModalYandex();

                // Показываем уведомление
                if (typeof window.showToast === 'function') {
                    window.showToast({
                        type: 'success',
                        message: '✅ Заявление подано и ожидает рассмотрения',
                        duration: 3000
                    });
                }

                // Тактильный отклик
                if (window.TelegramMiniApp) {
                    window.TelegramMiniApp.hapticFeedback('success');
                }

                return false;
            };

            // ============================================
            // РЕЕСТР ЗАЯВЛЕНИЙ
            // ============================================

            window.showApplicationsRegistry = function() {
                const applications = JSON.parse(localStorage.getItem('applications') || '[]');

                const typeTexts = {
                    join: 'О вступлении',
                    exit: 'О выходе',
                    transfer: 'О переходе паевого взноса',
                    payment: 'Об отсрочке платежа',
                    other: 'Другое'
                };

                const statusTexts = {
                    pending: '⏳ На рассмотрении',
                    approved: '✅ Одобрено',
                    rejected: '❌ Отклонено'
                };

                const statusColors = {
                    pending: '#ff9800',
                    approved: '#4caf50',
                    rejected: '#f44336'
                };

                let rowsHTML = '';
                if (applications.length === 0) {
                    rowsHTML = '<tr><td colspan="6" style="padding:40px;text-align:center;color:#999">Заявлений нет</td></tr>';
                } else {
                    applications.forEach((app, idx) => {
                        rowsHTML += `
                            <tr style="border-bottom:1px solid #eee">
                                <td style="padding:10px;text-align:center">${idx + 1}</td>
                                <td style="padding:10px">${new Date(app.createdAt).toLocaleDateString()}</td>
                                <td style="padding:10px">${app.fullName}</td>
                                <td style="padding:10px">${typeTexts[app.type]}</td>
                                <td style="padding:10px;text-align:center"><span style="color:${statusColors[app.status]}">${statusTexts[app.status]}</span></td>
                                <td style="padding:10px;text-align:center">
                                    ${app.status === 'pending' ? `
                                        <button onclick="approveApplication(${app.id})" style="padding:4px 8px;background:#4caf50;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;margin-right:4px">✅</button>
                                        <button onclick="rejectApplication(${app.id})" style="padding:4px 8px;background:#f44336;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px">❌</button>
                                    ` : '—'}
                                </td>
                            </tr>
                        `;
                    });
                }

                const content = `
                    <div style="padding:30px;max-width:1000px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600;text-align:center">📋 Реестр заявлений</h2>

                        <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:20px">
                            <thead>
                                <tr style="background:#f5f7fa">
                                    <th style="padding:12px;border:1px solid #ddd;text-align:center">№</th>
                                    <th style="padding:12px;border:1px solid #ddd;text-align:center">Дата</th>
                                    <th style="padding:12px;border:1px solid #ddd;text-align:left">Заявитель</th>
                                    <th style="padding:12px;border:1px solid #ddd;text-align:left">Тип</th>
                                    <th style="padding:12px;border:1px solid #ddd;text-align:center">Статус</th>
                                    <th style="padding:12px;border:1px solid #ddd;text-align:center">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHTML}
                            </tbody>
                        </table>

                        <div style="margin-top:20px;text-align:center">
                            <button onclick="closeModalYandex()"
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Закрыть
                            </button>
                        </div>
                    </div>
                `;

                showModalYandex(content);
            };

            window.approveApplication = function(appId) {
                const applications = JSON.parse(localStorage.getItem('applications') || '[]');
                const app = applications.find(a => a.id === appId);
                if (app) {
                    app.status = 'approved';
                    localStorage.setItem('applications', JSON.stringify(applications));
                    window.showApplicationsRegistry();  // Обновляем таблицу
                }
            };

            window.rejectApplication = function(appId) {
                const applications = JSON.parse(localStorage.getItem('applications') || '[]');
                const app = applications.find(a => a.id === appId);
                if (app) {
                    app.status = 'rejected';
                    localStorage.setItem('applications', JSON.stringify(applications));
                    window.showApplicationsRegistry();  // Обновляем таблицу
                }
            };

            // ============================================
            // СОБРАНИЯ И ПРОТОКОЛЫ
            // ============================================

            window.showMeetingsModal = function() {
                const meetings = JSON.parse(localStorage.getItem('meetings') || '[]');

                let meetingsHTML = '';
                if (meetings.length === 0) {
                    meetingsHTML = '<p style="text-align:center;color:#999;padding:40px">Собраний ещ�������� не было</p>';
                } else {
                    meetings.forEach((meeting, idx) => {
                        meetingsHTML += `
                            <div style="background:#f5f7fa;padding:15px;border-radius:8px;margin-bottom:15px">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                                    <h3 style="margin:0;font-size:16px">📋 Протокол №${meeting.number || idx + 1}</h3>
                                    <span style="font-size:13px;color:#666">${new Date(meeting.date).toLocaleDateString()}</span>
                                </div>
                                <p style="margin:0 0 10px 0;font-size:14px"><strong>Повестка:</strong> ${meeting.agenda || '—'}</p>
                                <p style="margin:0;font-size:13px;color:#666"><strong>Присутствовало:</strong> ${meeting.attendees || 0} чел.</p>
                            </div>
                        `;
                    });
                }

                const content = `
                    <div style="padding:30px;max-width:800px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600;text-align:center">🤝 Собрания и протоколы</h2>

                        ${meetingsHTML}

                        <div style="margin-top:20px;text-align:center">
                            <button onclick="showCreateMeetingModal()"
                                    style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;margin-right:10px">
                                📝 Создать протокол
                            </button>
                            <button onclick="closeModalYandex()"
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Закрыть
                            </button>
                        </div>
                    </div>
                `;

                showModalYandex(content);
            };

            window.showCreateMeetingModal = function() {
                const content = `
                    <div style="padding:30px;max-width:700px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">📝 Создать протокол собрания</h2>

                        <form id="createMeetingForm" onsubmit="return handleCreateMeeting(event)">
                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Номер протокола *</label>
                                <input type="text" name="number" required placeholder="№ 1" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Дата проведения *</label>
                                <input type="date" name="date" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Повестка дня *</label>
                                <textarea name="agenda" rows="4" required placeholder="1. Избрание председателя собрания..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"></textarea>
                            </div>

                            <div style="margin-bottom:20px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Присутствовало (чел.) *</label>
                                <input type="number" name="attendees" required min="1" placeholder="10" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                                <button type="button" onclick="closeModalYandex()"
                                        style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                    Отмена
                                </button>
                                <button type="submit"
                                        style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                    📝 Сохранить
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                showModalYandex(content);
            };

            window.handleCreateMeeting = function(event) {
                event.preventDefault();

                const form = event.target;
                const formData = new FormData(form);

                const meeting = {
                    id: Date.now(),
                    number: formData.get('number'),
                    date: formData.get('date'),
                    agenda: formData.get('agenda'),
                    attendees: parseInt(formData.get('attendees')),
                    createdAt: new Date().toISOString()
                };

                // Сохраняем в localStorage
                const meetings = JSON.parse(localStorage.getItem('meetings') || '[]');
                meetings.push(meeting);
                localStorage.setItem('meetings', JSON.stringify(meetings));

                // Закрываем модальное окно
                closeModalYandex();

                // Показываем уведомление
                if (typeof window.showToast === 'function') {
                    window.showToast({
                        type: 'success',
                        message: '✅ Протокол собрания создан',
                        duration: 3000
                    });
                }

                // Тактильный отклик
                if (window.TelegramMiniApp) {
                    window.TelegramMiniApp.hapticFeedback('success');
                }

                return false;
            };

            // ============================================
            // ДЕКЛАРАЦИЯ УСН
            // ============================================

            window.showUSNDeclarationModal = function() {
                const currentYear = new Date().getFullYear();
                const payments = JSON.parse(localStorage.getItem('payments') || '[]');
                const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');

                // Считаем доходы за год
                const yearPayments = payments.filter(p => p.date.startsWith(currentYear));
                const totalIncome = yearPayments.reduce((sum, p) => sum + p.amount, 0);

                // Считаем расходы за год
                const yearTransactions = transactions.filter(t => t.date.startsWith(currentYear));
                const totalExpenses = yearTransactions.reduce((sum, t) => sum + t.amount, 0);

                // Налоговая база и налог (УСН 6% или 15%)
                const taxRate = 6;  // УСН Доходы
                const taxAmount = Math.round(totalIncome * 0.06);
                const taxAmountDiff = Math.round(totalIncome * 0.15 - totalExpenses * 0.15);  // УСН Доходы-Расходы

                const content = `
                    <div style="padding:30px;max-width:800px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600;text-align:center">📊 Декларация УСН</h2>
                        <p style="text-align:center;color:#999;margin-bottom:20px">За ${currentYear} год</p>

                        <div style="background:#f5f7fa;padding:20px;border-radius:8px;margin-bottom:20px">
                            <h3 style="margin-bottom:15px;font-size:16px">📈 Показатели за год</h3>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                                <div>
                                    <div style="font-size:13px;color:#666">Доходы</div>
                                    <div style="font-size:24px;font-weight:700;color:#4caf50">${totalIncome.toLocaleString()} ₽</div>
                                </div>
                                <div>
                                    <div style="font-size:13px;color:#666">Расходы</div>
                                    <div style="font-size:24px;font-weight:700;color:#f44336">${totalExpenses.toLocaleString()} ₽</div>
                                </div>
                            </div>
                        </div>

                        <div style="background:#fff3cd;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #ffc107">
                            <div style="font-size:14px;color:#856404">
                                <strong>⚠️ Примечание:</strong> Для сдачи декларации в ФНС необходимо заполнить официальную форму в бухгалтерской программе (1С, Контур и т.д.).
                            </div>
                        </div>

                        <div style="margin-top:20px;text-align:center">
                            <button onclick="window.print()"
                                    style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;margin-right:10px">
                                🖨️ Печать
                            </button>
                            <button onclick="closeModalYandex()"
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Закрыть
                            </button>
                        </div>
                    </div>
                `;

                showModalYandex(content);
            };

            // ============================================
            // ПЛАТЁЖНОЕ ПОРУЧЕНИЕ
            // ============================================

            window.showPaymentOrderModal = function() {
                const members = JSON.parse(localStorage.getItem('members') || '[]');

                let memberOptions = '<option value="">Выберите пайщика</option>';
                members.forEach(member => {
                    memberOptions += `<option value="${member.id}">${member.name}</option>`;
                });

                const content = `
                    <div style="padding:30px;max-width:800px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">📄 Платёжное поручение</h2>

                        <form id="paymentOrderForm" onsubmit="return handlePaymentOrder(event)">
                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Номер *</label>
                                <input type="text" name="number" required placeholder="№ 1" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Дата *</label>
                                <input type="date" name="date" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Плательщик *</label>
                                <input type="text" name="payer" required placeholder="КПК «Название»" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Получатель *</label>
                                <select name="recipientId" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                    ${memberOptions}
                                </select>
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Сумма (₽) *</label>
                                <input type="number" name="amount" required min="1" step="0.01" placeholder="1000.00" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:20px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Назначение платежа *</label>
                                <textarea name="purpose" rows="3" required placeholder="Возврат паевого взноса..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"></textarea>
                            </div>

                            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                                <button type="button" onclick="closeModalYandex()"
                                        style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                    Отмена
                                </button>
                                <button type="submit"
                                        style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                    📄 Сформировать
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                showModalYandex(content);
            };

            window.handlePaymentOrder = function(event) {
                event.preventDefault();

                const form = event.target;
                const formData = new FormData(form);

                const recipientId = formData.get('recipientId');
                const amount = parseFloat(formData.get('amount'));

                const members = JSON.parse(localStorage.getItem('members') || '[]');
                const recipient = members.find(m => m.id == recipientId);

                if (!recipient) {
                    alert('Получатель не найден!');
                    return false;
                }

                // Создаём проводку (Дт 75.5 Кт 51)
                const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                transactions.push({
                    id: Date.now(),
                    debitAccount: '75.5',
                    creditAccount: '51',
                    amount: amount,
                    date: formData.get('date'),
                    description: `Платёжное поручение №${formData.get('number')}: ${formData.get('purpose')}`,
                    memberId: recipientId
                });
                localStorage.setItem('transactions', JSON.stringify(transactions));

                closeModalYandex();

                if (typeof window.showToast === 'function') {
                    window.showToast({
                        type: 'success',
                        message: `✅ Платёжное поручение №${formData.get('number')} создано`,
                        duration: 3000
                    });
                }

                if (window.TelegramMiniApp) {
                    window.TelegramMiniApp.hapticFeedback('success');
                }

                return false;
            };

            // ============================================
            // АКТ СВЕРКИ (ПОЛНАЯ ВЕРСИЯ)
            // ============================================

            window.showActSverkaFullModal = function() {
                const members = JSON.parse(localStorage.getItem('members') || '[]');
                const payments = JSON.parse(localStorage.getItem('payments') || '[]');
                const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');

                let memberOptions = '<option value="">Выберите пайщика</option>';
                members.forEach(member => {
                    const memberPayments = payments.filter(p => p.memberId == member.id);
                    const totalPaid = memberPayments.reduce((sum, p) => sum + p.amount, 0);
                    memberOptions += `<option value="${member.id}">${member.name} (внесено: ${totalPaid.toLocaleString()}₽)</option>`;
                });

                const content = `
                    <div style="padding:30px;max-width:800px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">📄 Акт сверки взаиморасчётов</h2>

                        <form id="actSverkaFullForm" onsubmit="return handleActSverkaFull(event)">
                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Пайщик *</label>
                                <select name="memberId" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                    ${memberOptions}
                                </select>
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Период *</label>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                                    <input type="date" name="dateFrom" required style="padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                    <input type="date" name="dateTo" required style="padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                </div>
                            </div>

                            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                                <button type="button" onclick="closeModalYandex()"
                                        style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                    Отмена
                                </button>
                                <button type="submit"
                                        style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                    📄 Сформировать
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                showModalYandex(content);
            };

            window.handleActSverkaFull = function(event) {
                event.preventDefault();

                const form = event.target;
                const formData = new FormData(form);

                const memberId = formData.get('memberId');
                const dateFrom = formData.get('dateFrom');
                const dateTo = formData.get('dateTo');

                const members = JSON.parse(localStorage.getItem('members') || '[]');
                const member = members.find(m => m.id == memberId);

                if (!member) {
                    alert('Пайщик не найден!');
                    return false;
                }

                const payments = JSON.parse(localStorage.getItem('payments') || '[]');
                const memberPayments = payments.filter(p => 
                    p.memberId == memberId && 
                    p.date >= dateFrom && 
                    p.date <= dateTo
                );

                const totalPaid = memberPayments.reduce((sum, p) => sum + p.amount, 0);

                let operationsHTML = '';
                if (memberPayments.length === 0) {
                    operationsHTML = '<p style="text-align:center;color:#999;padding:20px">Операций за период нет</p>';
                } else {
                    memberPayments.forEach((p, idx) => {
                        operationsHTML += `
                            <tr>
                                <td style="padding:8px;border:1px solid #ddd;text-align:center">${idx + 1}</td>
                                <td style="padding:8px;border:1px solid #ddd">${p.date}</td>
                                <td style="padding:8px;border:1px solid #ddd">${p.description || p.type}</td>
                                <td style="padding:8px;border:1px solid #ddd;text-align:right">—</td>
                                <td style="padding:8px;border:1px solid #ddd;text-align:right">${p.amount.toLocaleString()} ₽</td>
                            </tr>
                        `;
                    });
                }

                const actContent = `
                    <div style="padding:30px;max-width:800px;margin:0 auto">
                        <h2 style="text-align:center;font-size:18px;font-weight:600;margin-bottom:10px">АКТ СВЕРКИ ВЗАИМОРАСЧЁТОВ</h2>
                        <p style="text-align:center;color:#666;margin-bottom:30px">за период с ${new Date(dateFrom).toLocaleDateString()} по ${new Date(dateTo).toLocaleDateString()}</p>

                        <div style="margin-bottom:20px">
                            <p><strong>Организация:</strong> Кредитный потребительский кооператив</p>
                            <p><strong>Пайщик:</strong> ${member.name}</p>
                        </div>

                        <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:20px">
                            <thead>
                                <tr style="background:#f5f7fa">
                                    <th style="padding:10px;border:1px solid #ddd;text-align:center">№</th>
                                    <th style="padding:10px;border:1px solid #ddd;text-align:center">Дата</th>
                                    <th style="padding:10px;border:1px solid #ddd;text-align:left">Содержание операции</th>
                                    <th style="padding:10px;border:1px solid #ddd;text-align:right">Дебет</th>
                                    <th style="padding:10px;border:1px solid #ddd;text-align:right">Кредит</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${operationsHTML}
                            </tbody>
                        </table>

                        <div style="background:#f5f7fa;padding:15px;border-radius:8px;margin-bottom:20px">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
                                <div>
                                    <div style="font-size:13px;color:#666">Всего оплачено</div>
                                    <div style="font-size:20px;font-weight:700;color:#4caf50">${totalPaid.toLocaleString()} ₽</div>
                                </div>
                                <div>
                                    <div style="font-size:13px;color:#666">Задолженность</div>
                                    <div style="font-size:20px;font-weight:700;color:#4caf50">0 ₽</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top:30px;display:grid;grid-template-columns:1fr 1fr;gap:40px">
                            <div style="text-align:center">
                                <div style="border-top:1px solid #000;padding-top:5px;margin-top:40px">Председатель</div>
                            </div>
                            <div style="text-align:center">
                                <div style="border-top:1px solid #000;padding-top:5px;margin-top:40px">Пайщик</div>
                            </div>
                        </div>

                        <div style="margin-top:20px;text-align:center">
                            <button onclick="window.print()"
                                    style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;margin-right:10px">
                                🖨️ Печать
                            </button>
                            <button onclick="showActSverkaFullModal()"
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Назад
                            </button>
                        </div>
                    </div>
                `;

                showModalYandex(actContent);
                return false;
            };

            // ============================================
            // СЧЁТ НА ОПЛАТУ
            // ============================================

            window.showInvoiceModal = function() {
                const members = JSON.parse(localStorage.getItem('members') || '[]');

                let memberOptions = '<option value="">Выберите пайщика</option>';
                members.forEach(member => {
                    memberOptions += `<option value="${member.id}">${member.name}</option>`;
                });

                const content = `
                    <div style="padding:30px;max-width:800px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">📄 Счёт на оплату</h2>

                        <form id="invoiceForm" onsubmit="return handleInvoice(event)">
                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Номер счёта *</label>
                                <input type="text" name="number" required placeholder="№ 1" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Дата *</label>
                                <input type="date" name="date" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Плательщик *</label>
                                <select name="payerId" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                    ${memberOptions}
                                </select>
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Сумма (₽) *</label>
                                <input type="number" name="amount" required min="1" step="0.01" placeholder="1000.00" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:20px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Назначение платежа *</label>
                                <textarea name="purpose" rows="3" required placeholder="Вступительный взнос..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"></textarea>
                            </div>

                            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                                <button type="button" onclick="closeModalYandex()"
                                        style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                    Отмена
                                </button>
                                <button type="submit"
                                        style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                    📄 Сформировать
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                showModalYandex(content);
            };

            window.handleInvoice = function(event) {
                event.preventDefault();

                const form = event.target;
                const formData = new FormData(form);

                const payerId = formData.get('payerId');
                const amount = parseFloat(formData.get('amount'));
                const number = formData.get('number');

                const members = JSON.parse(localStorage.getItem('members') || '[]');
                const payer = members.find(m => m.id == payerId);

                if (!payer) {
                    alert('Плательщик не найден!');
                    return false;
                }

                // Создаём проводку (Дт 76 Кт 86)
                const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                transactions.push({
                    id: Date.now(),
                    debitAccount: '76',
                    creditAccount: '86',
                    amount: amount,
                    date: formData.get('date'),
                    description: `Счёт на оплату №${number}: ${formData.get('purpose')}`,
                    memberId: payerId
                });
                localStorage.setItem('transactions', JSON.stringify(transactions));

                closeModalYandex();

                if (typeof window.showToast === 'function') {
                    window.showToast({
                        type: 'success',
                        message: `✅ Счёт на оплату №${number} создан`,
                        duration: 3000
                    });
                }

                if (window.TelegramMiniApp) {
                    window.TelegramMiniApp.hapticFeedback('success');
                }

                return false;
            };

            // ============================================
            // ЗАГРУЗИТЬ ДОКУМЕНТ
            // ============================================

            window.showUploadDocumentModal = function() {
                const content = `
                    <div style="padding:30px;max-width:700px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">📁 Загрузить документ</h2>

                        <form id="uploadDocumentForm" onsubmit="return handleUploadDocument(event)">
                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Тип документа *</label>
                                <select name="type" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                    <option value="application">Заявление</option>
                                    <option value="protocol">Протокол</option>
                                    <option value="certificate">Удостоверение</option>
                                    <option value="invoice">Счёт</option>
                                    <option value="act">Акт</option>
                                    <option value="other">Другое</option>
                                </select>
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Название *</label>
                                <input type="text" name="title" required placeholder="Например: Заявление о вступлении" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Файл *</label>
                                <input type="file" name="file" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                <div style="font-size:12px;color:#666;margin-top:5px">Поддерживаемые форматы: PDF, DOC, DOCX, JPG, PNG</div>
                            </div>

                            <div style="margin-bottom:20px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Описание</label>
                                <textarea name="description" rows="3" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"></textarea>
                            </div>

                            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                                <button type="button" onclick="closeModalYandex()"
                                        style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                    Отмена
                                </button>
                                <button type="submit"
                                        style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                    📁 Загрузить
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                showModalYandex(content);
            };

            window.handleUploadDocument = function(event) {
                event.preventDefault();

                const form = event.target;
                const formData = new FormData(form);

                const document = {
                    id: Date.now(),
                    type: formData.get('type'),
                    title: formData.get('title'),
                    fileName: formData.get('file').name,
                    fileSize: (formData.get('file').size / 1024).toFixed(2) + ' KB',
                    description: formData.get('description'),
                    uploadedAt: new Date().toISOString(),
                    status: 'uploaded'
                };

                // Сохраняем в localStorage (в реальном приложении - загрузка на сервер)
                const documents = JSON.parse(localStorage.getItem('documents') || '[]');
                documents.push(document);
                localStorage.setItem('documents', JSON.stringify(documents));

                closeModalYandex();

                if (typeof window.showToast === 'function') {
                    window.showToast({
                        type: 'success',
                        message: `✅ Документ "${document.title}" загружен`,
                        duration: 3000
                    });
                }

                if (window.TelegramMiniApp) {
                    window.TelegramMiniApp.hapticFeedback('success');
                }

                return false;
            };

            // ============================================
            // АНАЛИТИКА
            // ============================================

            window.showAnalyticsModal = function() {
                const currentYear = new Date().getFullYear();
                const members = JSON.parse(localStorage.getItem('members') || '[]');
                const payments = JSON.parse(localStorage.getItem('payments') || '[]');
                const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');

                // Считаем показатели
                const totalMembers = members.length;
                const yearPayments = payments.filter(p => p.date.startsWith(currentYear));
                const totalIncome = yearPayments.reduce((sum, p) => sum + p.amount, 0);
                const yearTransactions = transactions.filter(t => t.date.startsWith(currentYear));
                const totalExpenses = yearTransactions.reduce((sum, t) => sum + t.amount, 0);
                const profit = totalIncome - totalExpenses;

                // Группируем по типам взносов
                const byType = {
                    entrance: { count: 0, sum: 0 },
                    membership: { count: 0, sum: 0 },
                    share: { count: 0, sum: 0 },
                    additional: { count: 0, sum: 0 }
                };
                yearPayments.forEach(p => {
                    if (byType[p.type]) {
                        byType[p.type].count++;
                        byType[p.type].sum += p.amount;
                    }
                });

                const typeNames = {
                    entrance: 'Вступительные',
                    membership: 'Членские',
                    share: 'Паевые',
                    additional: 'Дополнительные'
                };

                let chartHTML = '';
                Object.keys(byType).forEach(key => {
                    const percent = totalIncome > 0 ? Math.round((byType[key].sum / totalIncome) * 100) : 0;
                    chartHTML += `
                        <div style="margin-bottom:10px">
                            <div style="display:flex;justify-content:space-between;margin-bottom:5px">
                                <span style="font-size:13px">${typeNames[key]}</span>
                                <span style="font-size:13px;font-weight:600">${byType[key].sum.toLocaleString()} ₽ (${percent}%)</span>
                            </div>
                            <div style="background:#e0e0e0;height:20px;border-radius:10px;overflow:hidden">
                                <div style="background:#0088cc;height:100%;width:${percent}%;border-radius:10px;transition:width 0.5s"></div>
                            </div>
                        </div>
                    `;
                });

                const content = `
                    <div style="padding:30px;max-width:900px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600;text-align:center">📊 Аналитика</h2>
                        <p style="text-align:center;color:#999;margin-bottom:20px">За ${currentYear} год</p>

                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px">
                            <div style="background:#e8f5e9;padding:20px;border-radius:8px;text-align:center">
                                <div style="font-size:13px;color:#666">Пайщиков</div>
                                <div style="font-size:32px;font-weight:700;color:#4caf50">${totalMembers}</div>
                            </div>
                            <div style="background:#e3f2fd;padding:20px;border-radius:8px;text-align:center">
                                <div style="font-size:13px;color:#666">Доходы</div>
                                <div style="font-size:24px;font-weight:700;color:#2196f3">${totalIncome.toLocaleString()} ₽</div>
                            </div>
                            <div style="background:#ffebee;padding:20px;border-radius:8px;text-align:center">
                                <div style="font-size:13px;color:#666">Расходы</div>
                                <div style="font-size:24px;font-weight:700;color:#f44336">${totalExpenses.toLocaleString()} ₽</div>
                            </div>
                            <div style="background:#fff3e0;padding:20px;border-radius:8px;text-align:center">
                                <div style="font-size:13px;color:#666">Прибыль</div>
                                <div style="font-size:24px;font-weight:700;color:${profit >= 0 ? '#4caf50' : '#f44336'}">${profit.toLocaleString()} ₽</div>
                            </div>
                        </div>

                        <div style="background:#f5f7fa;padding:20px;border-radius:8px;margin-bottom:20px">
                            <h3 style="margin-bottom:15px;font-size:16px">📈 Структура доходов</h3>
                            ${chartHTML}
                        </div>

                        <div style="margin-top:20px;text-align:center">
                            <button onclick="window.print()"
                                    style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;margin-right:10px">
                                🖨️ Печать
                            </button>
                            <button onclick="closeModalYandex()"
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Закрыть
                            </button>
                        </div>
                    </div>
                `;

                showModalYandex(content);
            };

            // ============================================
            // ФОНДЫ
            // ============================================

            window.showFundsModal = function() {
                const funds = JSON.parse(localStorage.getItem('funds') || '[]');

                const fundTypes = {
                    reserve: { name: 'Резервный фонд', color: '#ff9800' },
                    mutualAid: { name: 'Фонд взаимопомощи', color: '#4caf50' },
                    financial: { name: 'Финансовый фонд', color: '#2196f3' },
                    other: { name: 'Другие фонды', color: '#9c27b0' }
                };

                let fundsHTML = '';
                if (funds.length === 0) {
                    fundsHTML = '<p style="text-align:center;color:#999;padding:40px">Фонды ещё не созданы</p>';
                } else {
                    funds.forEach((fund, idx) => {
                        const type = fundTypes[fund.type] || fundTypes.other;
                        fundsHTML += `
                            <div style="background:#f5f7fa;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid ${type.color}">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                                    <h3 style="margin:0;font-size:16px">${type.name}</h3>
                                    <span style="font-size:18px;font-weight:700;color:${type.color}">${fund.amount.toLocaleString()} ₽</span>
                                </div>
                                <p style="margin:0;font-size:13px;color:#666">${fund.description || '—'}</p>
                                <p style="margin:5px 0 0 0;font-size:12px;color:#999">Создан: ${new Date(fund.createdAt).toLocaleDateString()}</p>
                            </div>
                        `;
                    });
                }

                const content = `
                    <div style="padding:30px;max-width:800px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600;text-align:center">💰 Фонды кооператива</h2>

                        ${fundsHTML}

                        <div style="margin-top:20px;text-align:center">
                            <button onclick="showCreateFundModal()"
                                    style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;margin-right:10px">
                                ➕ Создать фонд
                            </button>
                            <button onclick="closeModalYandex()"
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Закрыть
                            </button>
                        </div>
                    </div>
                `;

                showModalYandex(content);
            };

            window.showCreateFundModal = function() {
                const content = `
                    <div style="padding:30px;max-width:700px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600">💰 Создать фонд</h2>

                        <form id="createFundForm" onsubmit="return handleCreateFund(event)">
                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Тип фонда *</label>
                                <select name="type" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                                    <option value="reserve">Резервный фонд</option>
                                    <option value="mutualAid">Фонд взаимопомощи</option>
                                    <option value="financial">Финансовый фонд</option>
                                    <option value="other">Другой фонд</option>
                                </select>
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Название *</label>
                                <input type="text" name="name" required placeholder="Например: Резервный фонд" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:15px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Начальная сумма (₽) *</label>
                                <input type="number" name="amount" required min="0" step="0.01" placeholder="10000.00" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px">
                            </div>

                            <div style="margin-bottom:20px">
                                <label style="display:block;margin-bottom:5px;font-weight:500">Описание</label>
                                <textarea name="description" rows="3" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"></textarea>
                            </div>

                            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                                <button type="button" onclick="closeModalYandex()"
                                        style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                    Отмена
                                </button>
                                <button type="submit"
                                        style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">
                                    💾 Создать
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                showModalYandex(content);
            };

            window.handleCreateFund = function(event) {
                event.preventDefault();

                const form = event.target;
                const formData = new FormData(form);

                const fund = {
                    id: Date.now(),
                    type: formData.get('type'),
                    name: formData.get('name'),
                    amount: parseFloat(formData.get('amount')),
                    description: formData.get('description'),
                    createdAt: new Date().toISOString()
                };

                // Сохраняем в localStorage
                const funds = JSON.parse(localStorage.getItem('funds') || '[]');
                funds.push(fund);
                localStorage.setItem('funds', JSON.stringify(funds));

                closeModalYandex();

                if (typeof window.showToast === 'function') {
                    window.showToast({
                        type: 'success',
                        message: `✅ Фонд "${fund.name}" создан`,
                        duration: 3000
                    });
                }

                if (window.TelegramMiniApp) {
                    window.TelegramMiniApp.hapticFeedback('success');
                }

                return false;
            };

            // ============================================
            // КОНТРОЛЬ СРОКОВ
            // ============================================

            window.showDeadlineControlModal = function() {
                const deadlines = [
                    { date: '20.03', name: 'Сдача декларации УСН', type: 'tax', urgent: true },
                    { date: '01.04', name: 'СЗВ-СТАЖ (годовой)', type: 'report', urgent: true },
                    { date: '20.04', name: 'РСВ (1 квартал)', type: 'tax', urgent: false },
                    { date: '01.05', name: 'СЗВ-М (ежемесячно)', type: 'report', urgent: false },
                    { date: '20.07', name: 'РСВ (полугодие)', type: 'tax', urgent: false },
                    { date: '01.08', name: 'СЗВ-М (ежемесячно)', type: 'report', urgent: false }
                ];

                const typeColors = {
                    tax: '#f44336',
                    report: '#2196f3',
                    meeting: '#4caf50',
                    other: '#ff9800'
                };

                const typeNames = {
                    tax: '📋 Налог',
                    report: '📊 Отчёт',
                    meeting: '🤝 Собрание',
                    other: '📅 Другое'
                };

                let deadlinesHTML = '';
                deadlines.forEach((dl, idx) => {
                    deadlinesHTML += `
                        <div style="background:${dl.urgent ? '#ffebee' : '#f5f7fa'};padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid ${typeColors[dl.type]}">
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <div>
                                    <div style="font-size:13px;color:#666;margin-bottom:5px">${typeNames[dl.type]}</div>
                                    <div style="font-size:15px;font-weight:600">${dl.name}</div>
                                </div>
                                <div style="text-align:right">
                                    <div style="font-size:18px;font-weight:700;color:${dl.urgent ? '#f44336' : '#666'}">${dl.date}</div>
                                    ${dl.urgent ? '<div style="font-size:11px;color:#f44336;font-weight:600">⚠️ СРОЧНО</div>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                const content = `
                    <div style="padding:30px;max-width:800px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600;text-align:center">⏰ Контроль сроков</h2>
                        <p style="text-align:center;color:#999;margin-bottom:20px">Календарь событий и дедлайнов</p>

                        ${deadlinesHTML}

                        <div style="margin-top:20px;text-align:center">
                            <button onclick="window.print()"
                                    style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;margin-right:10px">
                                🖨️ Печать
                            </button>
                            <button onclick="closeModalYandex()"
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Закрыть
                            </button>
                        </div>
                    </div>
                `;

                showModalYandex(content);
            };

            // ============================================
            // НУЛЕВАЯ ОТЧЁТНОСТЬ
            // ============================================

            window.showZeroReportingModal = function() {
                const currentYear = new Date().getFullYear();

                const content = `
                    <div style="padding:30px;max-width:800px;margin:0 auto">
                        <h2 style="margin-bottom:20px;font-size:20px;font-weight:600;text-align:center">📄 Нулевая отчётность</h2>
                        <p style="text-align:center;color:#999;margin-bottom:20px">За ${currentYear} год</p>

                        <div style="background:#fff3cd;padding:20px;border-radius:8px;margin-bottom:20px;border-left:4px solid #ffc107">
                            <div style="font-size:14px;color:#856404">
                                <strong>⚠️ Информация:</strong> Нулевая отчётность сдаётся при отсутствии деятельности (нет доходов и расходов).
                            </div>
                        </div>

                        <div style="background:#f5f7fa;padding:20px;border-radius:8px;margin-bottom:20px">
                            <h3 style="margin-bottom:15px;font-size:16px">📋 Состав нулевой отчётности</h3>
                            <div style="display:grid;gap:10px">
                                <div style="background:#fff;padding:12px;border-radius:6px;display:flex;justify-content:space-between;align-items:center">
                                    <span>📊 Декларация УСН (нулевая)</span>
                                    <span style="color:#4caf50">✅ Готово</span>
                                </div>
                                <div style="background:#fff;padding:12px;border-radius:6px;display:flex;justify-content:space-between;align-items:center">
                                    <span>📋 РСВ (нулевой)</span>
                                    <span style="color:#4caf50">✅ Готово</span>
                                </div>
                                <div style="background:#fff;padding:12px;border-radius:6px;display:flex;justify-content:space-between;align-items:center">
                                    <span>📄 6-НДФЛ (нулевой)</span>
                                    <span style="color:#4caf50">✅ Готово</span>
                                </div>
                                <div style="background:#fff;padding:12px;border-radius:6px;display:flex;justify-content:space-between;align-items:center">
                                    <span>📊 Бухгалтерский баланс (нулевой)</span>
                                    <span style="color:#4caf50">✅ Готово</span>
                                </div>
                                <div style="background:#fff;padding:12px;border-radius:6px;display:flex;justify-content:space-between;align-items:center">
                                    <span>📊 Отчёт о фин. результатах (нулевой)</span>
                                    <span style="color:#4caf50">✅ Готово</span>
                                </div>
                            </div>
                        </div>

                        <div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px">
                            <div style="font-size:14px;color:#1565c0">
                                <strong>ℹ️ Сроки сдачи:</strong>
                                <ul style="margin:10px 0 0 20px">
                                    <li>Декларация УСН — до 31 марта</li>
                                    <li>РСВ — до 30 апреля</li>
                                    <li>6-НДФЛ — до 30 апреля</li>
                                    <li>Бухгалтерский баланс — до 31 марта</li>
                                </ul>
                            </div>
                        </div>

                        <div style="margin-top:20px;text-align:center">
                            <button onclick="window.print()"
                                    style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;margin-right:10px">
                                🖨️ Печать
                            </button>
                            <button onclick="closeModalYandex()"
                                    style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                                Закрыть
                            </button>
                        </div>
                    </div>
                `;

                showModalYandex(content);
            };

        // ============================================
        // КАССОВАЯ КНИГА
        // ============================================

        window.showCashBookModal = function() {
            const currentYear = new Date().getFullYear();
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');

            // Фильтруем за текущий год
            const yearTransactions = transactions.filter(t => t.date.startsWith(currentYear));

            let rowsHTML = '';
            let balance = 0;

            if (yearTransactions.length === 0) {
                rowsHTML = '<tr><td colspan="5" style="padding:40px;text-align:center;color:#999">Операций за год нет</td></tr>';
            } else {
                yearTransactions.forEach((t, idx) => {
                    const isDebit = ['50', '51'].includes(t.debitAccount);
                    if (isDebit) balance += t.amount;
                    else balance -= t.amount;

                    rowsHTML += `
                        <tr style="border-bottom:1px solid #eee">
                            <td style="padding:10px;text-align:center">${idx + 1}</td>
                            <td style="padding:10px;text-align:center">${t.date || '—'}</td>
                            <td style="padding:10px">${t.description || '—'}</td>
                            <td style="padding:10px;text-align:right;color:${isDebit ? '#4caf50' : '#f44336'}">${isDebit ? t.amount.toLocaleString() : '—'}</td>
                            <td style="padding:10px;text-align:right;color:${!isDebit ? '#f44336' : '#4caf50'}">${!isDebit ? t.amount.toLocaleString() : '—'}</td>
                        </tr>
                    `;
                });
            }

            const content = `
                <div style="padding:30px;max-width:900px;margin:0 auto">
                    <h2 style="margin-bottom:10px;font-size:20px;font-weight:600;text-align:center">📒 Кассовая книга</h2>
                    <p style="text-align:center;color:#999;margin-bottom:20px">За ${currentYear} год</p>

                    <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:20px">
                        <thead>
                            <tr style="background:#f5f7fa">
                                <th style="padding:12px;border:1px solid #ddd;text-align:center" rowspan="2">№</th>
                                <th style="padding:12px;border:1px solid #ddd;text-align:center" rowspan="2">Дата</th>
                                <th style="padding:12px;border:1px solid #ddd;text-align:left" rowspan="2">Содержание операции</th>
                                <th style="padding:12px;border:1px solid #ddd;text-align:center" colspan="2">Сумма (₽)</th>
                            </tr>
                            <tr style="background:#f5f7fa">
                                <th style="padding:8px;border:1px solid #ddd;text-align:right">Дебет</th>
                                <th style="padding:8px;border:1px solid #ddd;text-align:right">Кредит</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHTML}
                        </tbody>
                    </table>

                    <div style="margin-top:20px;text-align:center">
                        <button onclick="window.print()"
                                style="padding:12px 24px;background:#0088cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;margin-right:10px">
                            🖨️ Печать
                        </button>
                        <button onclick="closeModalYandex()"
                                style="padding:12px 24px;background:#f5f7fa;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:15px">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;

            showModalYandex(content);
        };

        // ============================================
        // ЭКСПОРТ В EXCEL
        // ============================================

        window.exportToExcel = function(type) {
            const types = {
                members: { name: 'Па��щики', data: JSON.parse(localStorage.getItem('members') || '[]') },
                payments: { name: 'Взносы', data: JSON.parse(localStorage.getItem('payments') || '[]') },
                transactions: { name: 'Проводки', data: JSON.parse(localStorage.getItem('transactions') || '[]') }
            };

            const exportData = types[type];
            if (!exportData || exportData.data.length === 0) {
                alert('Нет данных для экспорта!');
                return;
            }

            // Создаём CSV
            const headers = Object.keys(exportData.data[0] || {});
            const csv = [
                headers.join(','),
                ...exportData.data.map(row => headers.map(h => `"${row[h] || ''}"`).join(','))
            ].join('\n');

            // Скачиваем файл
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${exportData.name}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            if (typeof window.showToast === 'function') {
                window.showToast({
                    type: 'success',
                    message: `✅ ${exportData.name} экспортированы в Excel`,
                    duration: 3000
                });
            }
        };

        // Закрываем второй DOMContentLoaded (обработчики кнопок)
        });

        // Закрываем первый DOMContentLoaded
        });

        console.log('🚀 Telegram Mini App запущен');
    </script>
</body>
</html>
