<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; background: #f5f7fa; }
        .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; margin-bottom: 16px; }
        h2 { font-size: 18px; margin: 24px 0 12px; }
        .btn { display: inline-block; padding: 12px 24px; background: #2196F3; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; font-size: 16px; margin: 5px; }
        .btn:hover { background: #1976D2; }
        .btn.success { background: #4CAF50; }
        .btn.success:hover { background: #388E3C; }
        .btn.warning { background: #FF9800; }
        .btn.warning:hover { background: #F57C00; }
        .btn.danger { background: #F44336; }
        .btn.danger:hover { background: #D32F2F; }
        .log { background: #1e1e1e; color: #fff; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 13px; max-height: 400px; overflow-y: auto; margin-top: 20px; }
        .status { padding: 12px; border-radius: 8px; margin: 16px 0; }
        .status.success { background: #e8f5e9; color: #2e7d32; }
        .status.error { background: #ffebee; color: #c62828; }
        .status.info { background: #e3f2fd; color: #1976d2; }
        code { background: #f5f7fa; padding: 2px 6px; border-radius: 4px; font-size: 13px; }
        .data-preview { background: #f5f7fa; padding: 12px; border-radius: 8px; font-size: 13px; max-height: 200px; overflow-y: auto; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="card">
        <h1>üß™ –¢–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫</h1>
        
        <div id="status" class="status info">
            <strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="statusText">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</span>
        </div>

        <div><strong>–¢–æ–∫–µ–Ω:</strong> <code id="tokenStatus">‚ùå –ù–µ –ø–æ–ª—É—á–µ–Ω</code></div>
        <div><strong>–ü–∞–ø–∫–∞:</strong> <code id="folderStatus">‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞</code></div>
        <div><strong>–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:</strong> <code id="lastSync">‚Äî</code></div>

        <h2>üìä –î–∞–Ω–Ω—ã–µ –≤ localStorage</h2>
        <div id="localData"></div>

        <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
        <button class="btn" onclick="checkConnection()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
        <button class="btn success" onclick="saveToYandex()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫</button>
        <button class="btn warning" onclick="loadFromYandex()">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞</button>
        <button class="btn" onclick="createBackup()">üóÑÔ∏è –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</button>
        <button class="btn danger" onclick="clearLocalData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å localStorage</button>
        <button class="btn" onclick="exportLocalData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (JSON)</button>

        <h2>–õ–æ–≥</h2>
        <div class="log" id="log"></div>
    </div>

    <script>
        const CONFIG = {
            CLIENT_ID: '3772de21483443aba93e1889bd7ca4dc',
            FOLDER_NAME: '–ö–û–û–ü–ï–†–ê–ù–¢',
            REDIRECT_URI: 'https://kkav45.github.io/cooperant/yandex-auth-callback.html'
        };

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#2196f3';
            logEl.innerHTML += `<div style="color:${color}">[${time}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log('[Sync Test]', message);
        }

        function checkConnection() {
            const token = localStorage.getItem('yandexDiskToken');
            const folderId = localStorage.getItem('yandexCooperativFolderId');

            document.getElementById('tokenStatus').textContent = token ? `‚úÖ –ü–æ–ª—É—á–µ–Ω (${token.substring(0, 20)}...)` : '‚ùå –ù–µ –ø–æ–ª—É—á–µ–Ω';
            document.getElementById('tokenStatus').style.color = token ? '#4caf50' : '#f44336';

            document.getElementById('folderStatus').textContent = folderId ? `‚úÖ ${folderId}` : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞';
            document.getElementById('folderStatus').style.color = folderId ? '#4caf50' : '#f44336';

            if (token && folderId) {
                document.getElementById('status').className = 'status success';
                document.getElementById('statusText').textContent = '‚úÖ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω';
                log('‚úÖ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω', 'success');
                testYandexAPI(token);
            } else if (token) {
                document.getElementById('status').className = 'status info';
                document.getElementById('statusText').textContent = '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞';
                log('‚ö†Ô∏è –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω, –Ω–æ –ø–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'warning');
            } else {
                document.getElementById('status').className = 'status error';
                document.getElementById('statusText').textContent = '‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è';
                log('‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error');
            }
        }

        async function testYandexAPI(token) {
            log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API...', 'info');
            try {
                const response = await fetch(`https://cloud-api.yandex.net/v1/disk/resources?path=app-folder:/${CONFIG.FOLDER_NAME}`, {
                    headers: { 'Authorization': `OAuth ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ –ü–∞–ø–∫–∞ –Ω–∞–π–¥–µ–Ω–∞: ${data.name}`, 'success');
                    log(`üìÅ –ü—É—Ç—å: ${data.path}`, 'success');
                    
                    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
                    const lastModified = data.last_modified ? new Date(data.last_modified).toLocaleString('ru-RU') : '‚Äî';
                    document.getElementById('lastSync').textContent = lastModified;
                } else {
                    const error = await response.json();
                    log(`‚ùå –û—à–∏–±–∫–∞ API: ${error.message || response.status}`, 'error');
                }
            } catch (err) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${err.message}`, 'error');
            }
        }

        function showLocalData() {
            const data = {
                members: JSON.parse(localStorage.getItem('members') || '[]'),
                payments: JSON.parse(localStorage.getItem('payments') || '[]'),
                transactions: JSON.parse(localStorage.getItem('transactions') || '[]'),
                documents: JSON.parse(localStorage.getItem('documents') || '[]'),
                applications: JSON.parse(localStorage.getItem('applications') || '[]'),
                meetings: JSON.parse(localStorage.getItem('meetings') || '[]'),
                certificates: JSON.parse(localStorage.getItem('certificates') || '[]')
            };

            let html = '<div class="data-preview">';
            for (const [key, value] of Object.entries(data)) {
                const count = Array.isArray(value) ? value.length : Object.keys(value).length;
                html += `<div><strong>${key}:</strong> ${count} –∑–∞–ø–∏—Å–µ–π</div>`;
            }
            html += '</div>';
            document.getElementById('localData').innerHTML = html;
        }

        async function saveToYandex() {
            const token = localStorage.getItem('yandexDiskToken');
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å', 'error');
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω!');
                return;
            }

            log('üíæ –ù–∞—á–∞–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö...', 'info');

            const files = [
                { name: 'coop_members.json', key: 'members' },
                { name: 'coop_payments.json', key: 'payments' },
                { name: 'coop_transactions.json', key: 'transactions' },
                { name: 'coop_documents.json', key: 'documents' },
                { name: 'coop_applications.json', key: 'applications' },
                { name: 'coop_meetings.json', key: 'meetings' },
                { name: 'coop_certificates.json', key: 'certificates' },
                { name: 'coop_settings.json', key: 'coopSettings' }
            ];

            let savedCount = 0;

            for (const file of files) {
                try {
                    const data = JSON.parse(localStorage.getItem(file.key) || '[]');
                    if (data && (Array.isArray(data) ? data.length > 0 : Object.keys(data).length > 0)) {
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const formData = new FormData();
                        formData.append('file', blob);

                        const uploadUrl = `https://cloud-api.yandex.net/v1/disk/resources/upload?path=app-folder:/${CONFIG.FOLDER_NAME}/${file.name}&overwrite=true`;

                        const uploadResponse = await fetch(uploadUrl, {
                            method: 'POST',
                            headers: { 'Authorization': `OAuth ${token}` },
                            body: formData
                        });

                        if (uploadResponse.ok) {
                            log(`‚úÖ ${file.name} —Å–æ—Ö—Ä–∞–Ω—ë–Ω`, 'success');
                            savedCount++;
                        } else {
                            log(`‚ùå ${file.name} –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω`, 'error');
                        }
                    }
                } catch (e) {
                    log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ${file.name}: ${e.message}`, 'warning');
                }
            }

            log(`üìä –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${savedCount} –∏–∑ ${files.length} —Ñ–∞–π–ª–æ–≤`, savedCount === files.length ? 'success' : 'warning');
            alert(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${savedCount} –∏–∑ ${files.length} —Ñ–∞–π–ª–æ–≤`);
        }

        async function loadFromYandex() {
            const token = localStorage.getItem('yandexDiskToken');
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å', 'error');
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω!');
                return;
            }

            log('üì• –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...', 'info');

            const files = [
                { name: 'coop_members.json', key: 'members' },
                { name: 'coop_payments.json', key: 'payments' },
                { name: 'coop_transactions.json', key: 'transactions' },
                { name: 'coop_documents.json', key: 'documents' },
                { name: 'coop_applications.json', key: 'applications' },
                { name: 'coop_meetings.json', key: 'meetings' },
                { name: 'coop_certificates.json', key: 'certificates' },
                { name: 'coop_settings.json', key: 'coopSettings' }
            ];

            let loadedCount = 0;

            for (const file of files) {
                try {
                    const downloadUrl = `https://cloud-api.yandex.net/v1/disk/resources/download?path=app-folder:/${CONFIG.FOLDER_NAME}/${file.name}`;

                    const response = await fetch(downloadUrl, {
                        headers: { 'Authorization': `OAuth ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const fileResponse = await fetch(data.file);
                        const fileData = await fileResponse.json();

                        localStorage.setItem(file.key, JSON.stringify(fileData));
                        log(`‚úÖ ${file.name} –∑–∞–≥—Ä—É–∂–µ–Ω`, 'success');
                        loadedCount++;
                    } else {
                        log(`‚ö†Ô∏è ${file.name} –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'warning');
                    }
                } catch (e) {
                    log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${file.name}: ${e.message}`, 'warning');
                }
            }

            log(`üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${loadedCount} –∏–∑ ${files.length} —Ñ–∞–π–ª–æ–≤`, loadedCount === files.length ? 'success' : 'warning');
            showLocalData();
            alert(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${loadedCount} –∏–∑ ${files.length} —Ñ–∞–π–ª–æ–≤`);
        }

        async function createBackup() {
            const token = localStorage.getItem('yandexDiskToken');
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å', 'error');
                return;
            }

            log('üóÑÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...', 'info');

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const backupFileName = `backup_${timestamp}.json`;

            const allData = {
                timestamp: timestamp,
                members: JSON.parse(localStorage.getItem('members') || '[]'),
                payments: JSON.parse(localStorage.getItem('payments') || '[]'),
                transactions: JSON.parse(localStorage.getItem('transactions') || '[]'),
                documents: JSON.parse(localStorage.getItem('documents') || '[]'),
                applications: JSON.parse(localStorage.getItem('applications') || '[]'),
                meetings: JSON.parse(localStorage.getItem('meetings') || '[]'),
                certificates: JSON.parse(localStorage.getItem('certificates') || '[]'),
                settings: JSON.parse(localStorage.getItem('coopSettings') || '{}')
            };

            try {
                const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
                const formData = new FormData();
                formData.append('file', blob);

                const uploadUrl = `https://cloud-api.yandex.net/v1/disk/resources/upload?path=app-folder:/${CONFIG.FOLDER_NAME}/Backup/${backupFileName}&overwrite=true`;

                const uploadResponse = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: { 'Authorization': `OAuth ${token}` },
                    body: formData
                });

                if (uploadResponse.ok) {
                    log(`‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: ${backupFileName}`, 'success');
                    alert('‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
                } else {
                    const error = await uploadResponse.json();
                    log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                }
            } catch (err) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`, 'error');
            }
        }

        function clearLocalData() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ localStorage?')) {
                localStorage.removeItem('members');
                localStorage.removeItem('payments');
                localStorage.removeItem('transactions');
                localStorage.removeItem('documents');
                localStorage.removeItem('applications');
                localStorage.removeItem('meetings');
                localStorage.removeItem('certificates');
                localStorage.removeItem('coopSettings');
                log('üóëÔ∏è –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'success');
                showLocalData();
            }
        }

        function exportLocalData() {
            const allData = {
                members: JSON.parse(localStorage.getItem('members') || '[]'),
                payments: JSON.parse(localStorage.getItem('payments') || '[]'),
                transactions: JSON.parse(localStorage.getItem('transactions') || '[]'),
                documents: JSON.parse(localStorage.getItem('documents') || '[]'),
                applications: JSON.parse(localStorage.getItem('applications') || '[]'),
                meetings: JSON.parse(localStorage.getItem('meetings') || '[]'),
                certificates: JSON.parse(localStorage.getItem('certificates') || '[]')
            };

            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `koop_local_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            log('üì§ –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        showLocalData();
        checkConnection();
    </script>
</body>
</html>
