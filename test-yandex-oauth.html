<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ OAuth</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            font-size: 24px;
            margin-bottom: 16px;
        }
        h2 {
            font-size: 18px;
            margin: 24px 0 12px;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #fc0;
            color: #000;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background: #f9a800;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
        }
        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
        }
        code {
            background: #f5f7fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
        }
        .log {
            background: #1e1e1e;
            color: #fff;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-item {
            margin-bottom: 8px;
        }
        .log-item.error {
            color: #f44336;
        }
        .log-item.success {
            color: #4caf50;
        }
        .log-item.info {
            color: #2196f3;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>üß™ –¢–µ—Å—Ç –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ OAuth</h1>
        <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞.</p>
        
        <div id="status" class="status info">
            <strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="statusText">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
        </div>

        <h2>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h2>
        <div><strong>Client ID:</strong> <code id="clientId">...</code></div>
        <div><strong>Redirect URI:</strong> <code id="redirectUri">...</code></div>
        <div><strong>Scope:</strong> <code>disk:app_folder</code></div>
        <div><strong>Token:</strong> <code id="tokenStatus">–ù–µ –ø–æ–ª—É—á–µ–Ω</code></div>

        <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
        <button class="btn" onclick="testAuth()">üîê –ù–∞—á–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
        <button class="btn" onclick="clearToken()" style="margin-left: 10px; background: #f44336; color: white;">üö™ –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
        <button class="btn" onclick="testAPI()" style="margin-left: 10px; background: #4caf50; color: white;">üìä –¢–µ—Å—Ç API</button>

        <h2>–õ–æ–≥</h2>
        <div class="log" id="log"></div>
    </div>

    <script>
        const CONFIG = {
            CLIENT_ID: '3772de21483443aba93e1889bd7ca4dc',
            REDIRECT_URI: 'https://kkav45.github.io/cooperant/yandex-auth-callback.html',
            SCOPE: 'disk:app_folder'
        };

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const item = document.createElement('div');
            item.className = `log-item ${type}`;
            item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(item);
            logEl.scrollTop = logEl.scrollHeight;
            console.log('[OAuth Test]', message);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
        function checkStatus() {
            const token = localStorage.getItem('yandexDiskToken');
            const tokenStatus = document.getElementById('tokenStatus');
            
            if (token) {
                tokenStatus.textContent = '‚úÖ –ü–æ–ª—É—á–µ–Ω (' + token.substring(0, 20) + '...)';
                tokenStatus.style.color = '#4caf50';
                log('–¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω –≤ localStorage', 'success');
            } else {
                tokenStatus.textContent = '‚ùå –ù–µ –ø–æ–ª—É—á–µ–Ω';
                tokenStatus.style.color = '#f44336';
                log('–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            const urlParams = new URLSearchParams(window.location.search);
            const hash = window.location.hash;
            
            if (urlParams.get('access_token')) {
                log('–¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω –≤ URL parameters', 'success');
                handleToken(urlParams.get('access_token'));
            } else if (hash && hash.includes('access_token')) {
                log('–¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω –≤ hash', 'success');
                const hashParams = new URLSearchParams(hash.substring(1));
                handleToken(hashParams.get('access_token'));
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–∫–µ–Ω–∞
        function handleToken(token) {
            localStorage.setItem('yandexDiskToken', token);
            log('–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ localStorage', 'success');
            checkStatus();
            
            // –û—á–∏—â–∞–µ–º URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function testAuth() {
            log('–ù–∞—á–∞–ª–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...', 'info');
            
            const authUrl = `https://oauth.yandex.ru/authorize?` +
                `response_type=token&` +
                `client_id=${CONFIG.CLIENT_ID}&` +
                `redirect_uri=${encodeURIComponent(CONFIG.REDIRECT_URI)}&` +
                `scope=${encodeURIComponent(CONFIG.SCOPE)}`;

            log(`–û—Ç–∫—Ä—ã—Ç–∏–µ: ${authUrl}`, 'info');
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
            const authWindow = window.open(authUrl, '_blank', 'width=600,height=700');
            
            if (!authWindow) {
                log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –æ–∫–æ–Ω.', 'error');
            } else {
                log('‚úÖ –û–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç–æ. –ü—Ä–æ–π–¥–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ –æ—Ç–∫—Ä—ã–≤—à–µ–º—Å—è –æ–∫–Ω–µ.', 'info');
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ç–æ–∫–µ–Ω–∞
        function clearToken() {
            localStorage.removeItem('yandexDiskToken');
            localStorage.removeItem('yandexCooperativFolderId');
            log('–¢–æ–∫–µ–Ω –æ—á–∏—â–µ–Ω', 'success');
            checkStatus();
        }

        // –¢–µ—Å—Ç API
        async function testAPI() {
            const token = localStorage.getItem('yandexDiskToken');
            
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω', 'error');
                return;
            }

            log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API...', 'info');

            try {
                // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∞–ø–∫–µ
                const response = await fetch('https://cloud-api.yandex.net/v1/disk/resources?path=app-folder:/', {
                    headers: {
                        'Authorization': `OAuth ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–∞–ø–∫–∞ –Ω–∞–π–¥–µ–Ω–∞.', 'success');
                    log(`–ò–º—è –ø–∞–ø–∫–∏: ${data.name}`, 'success');
                    log(`–ü—É—Ç—å: ${data.path}`, 'success');
                } else {
                    const error = await response.json();
                    log(`‚ùå –û—à–∏–±–∫–∞ API: ${error.message || response.status}`, 'error');
                }
            } catch (err) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${err.message}`, 'error');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        document.getElementById('clientId').textContent = CONFIG.CLIENT_ID;
        document.getElementById('redirectUri').textContent = CONFIG.REDIRECT_URI;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        checkStatus();

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç callback –æ–∫–Ω–∞
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'YANDEX_TOKEN') {
                log('–ü–æ–ª—É—á–µ–Ω —Ç–æ–∫–µ–Ω –∏–∑ callback –æ–∫–Ω–∞', 'success');
                handleToken(event.data.token);
            }
        });
    </script>
</body>
</html>
